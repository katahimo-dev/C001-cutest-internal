# セキュリティ強化実施報告書

2026年1月26日に実施されたセキュリティ強化施策の詳細と、導入前後の比較をまとめました。

## 1. 実施された対策一覧

### A. 認証システムの抜本的強化
| 項目 | 旧仕様 (Before) | 新仕様 (After) | セキュリティ向上点 |
| :--- | :--- | :--- | :--- |
| **パスワード保存** | 平文保存 | **Salt付き SHA-256 ハッシュ化** | 管理シートが流出してもパスワード自体は復元不可能。Salt追加によりレインボーテーブル攻撃（※）も無効化。<br><br>※**レインボーテーブル攻撃**: 「よくあるパスワード」と「そのハッシュ値」の膨大な対応表（レインボーテーブル）を使って、ハッシュ値から元のパスワードを逆引きする攻撃手法。<br>今回の対策では、パスワードにユニークな秘密の文字列（Salt）を混ぜてからハッシュ化するため、市販のレインボーテーブルが一切通用しなくなります。 |
| **ユーザー認証** | 名前の一致で許可 | **メールアドレス認証 + トークン発行** | IDにユニークな「メールアドレス」を使用し、なりすましリスクを低減。 |
| **セッション管理** | 名前をlocalStorageに保存 | **発行されたトークンを保存** | ログイン後にサーバーから発行された「使い捨てトークン」でのみアクセス可能。名前情報の偽装による不正アクセスを遮断。 |
| **有効期限** | なし（無限） | **7日間のローリング有効期限** | 長期間放置された端末からの不正アクセスを防止。継続利用時は自動延長する利便性も確保。 |

### B. 運用フローの改善
- **パスワード変更機能の追加**: ユーザー自身が任意のタイミングでパスワードを変更可能に。
- **セルフパスワードリセット**: 管理者を介さず、登録メールアドレスへの「認証コード送信」により、本人確認をした上で安全にリセットが可能に。
- **データ移行**: 旧パスワードユーザーが初回ログインした際、自動的にハッシュ化された安全なパスワード形式へ移行する仕組みを導入。

### C. クライアントデータ保護（実施中）
- **顧客リストの扱い**:
    - **Before**: `localStorage`（永続保存）を使用。PC紛失時やブラウザを閉じてもデータが残るリスクがあった。
    - **After**: `sessionStorage`（一時保存）へ移行。ブラウザやタブを閉じると即座にデータが破棄されるため、共有PCでの利用や紛失時のリスクが極小化された。
- **通信の高速化**: 
    - サーバーサイドキャッシュ (`CacheService`) を導入し、データ取得頻度を下げつつ高速化を実現。

---

## 2. システム構成の変化

### コード修正箇所 (`Code.js`)
1.  **`computeHash(raw)`**: パスワードに「Salt（秘密文字）」を加えてハッシュ化する関数を追加。
2.  **`verifyLogin(email, password)`**: メールアドレスによる検索とハッシュ照合、およびトークン発行処理に変更。
3.  **`checkSession(token)`**: トークンの有効性と期限を検証する認証ガード関数を実装。
4.  **`requestPasswordReset(email)`**: パスワードリセット専用シートに行を追加し、認証コードをメール送信。
5.  **`resetPasswordWithCode(email, code, newPass)`**: コード検証後、パスワードを上書き（ハッシュ化）保存。
6.  **`changePassword(token, current, new)`**: ログイン状態でのパスワード変更機能。

### 画面修正箇所 (`index.html`)
1.  **ログイン画面**: ユーザーID欄を「メールアドレス」に変更。
2.  **パスワードリセット**: 「パスワードを忘れた場合」リンクと、認証コード入力モーダルを追加。
3.  **設定画面**: 「パスワード変更」ボタンを追加。
4.  **データ管理**: `loadData` 処理内の保存先を `sessionStorage` に変更（※実装中項目の反映）。

---

## 3. 今後の運用について
- **管理者**: 新規スタッフ登録時は「メールアドレス」を必ず入力してください（リセット機能のため）。
- **ユーザー**: 初回ログイン時にこれまでのID/PASSで入れない場合は、メールアドレスでログインし直してください。

---

## 4. 総合評価と残存リスク

### セキュリティ評価: **高 (業務アプリとして推奨される水準)**
本改修により、一般的なWebアプリケーションに求められる認証・データ保護要件（OWASP Top 10等で指摘される主要リスク）の大部分をクリアしました。
特に「なりすまし不可能」「PC紛失時のデータ保護」「パスワード漏洩時の被害防止」の3点が確立されたことで、個人情報を取り扱う保育業務においても安心して利用できるレベルに達しています。

### 残された懸念事項 (Remaining Risks)と対策
システム側での対策は完了しましたが、運用環境に依存する以下のリスクが残ります。

1.  **Googleアカウント自体の保護**
    - 本アプリはGoogle Apps Script上で動作しているため、開発者や管理者の「Googleアカウント」そのものが乗っ取られると、すべてのデータにアクセスされてしまいます。
    - **対策**: Googleアカウントへの「2段階認証 (2FA)」導入を強く推奨します。

2.  **スプレッドシートの共有設定**
    - データベースとなっているスプレッドシート自体の「共有設定」が「リンクを知っている全員が閲覧可」などになっていると、認証を迂回してデータが見られてしまいます。
    - **対策**: ファイルの共有範囲が「特定のユーザーのみ」になっているか定期的に確認してください。

3.  **ブラウザ拡張機能のリスク**
    - ユーザーが利用するブラウザに悪意のある拡張機能がインストールされている場合、画面上のデータや `sessionStorage` が読み取られる可能性があります。
    - **対策**: 業務端末では許可された拡張機能以外をブロックする、または信頼できる端末のみ使用する運用ルールが必要です。


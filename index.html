<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰øùËÇ≤Êó•Â†±„Ç¢„Éó„É™</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f3f4f6;
        }

        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .loading-spinner {
            border-top-color: #3b82f6;
            border-left-color: #3b82f6;
            animation: spin 1s infinite linear;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Font Size Settings */
        html[data-text-size="medium"] .text-xs {
            font-size: 0.875rem !important;
            line-height: 1.4 !important;
        }

        html[data-text-size="medium"] .text-sm {
            font-size: 1rem !important;
            line-height: 1.5 !important;
        }

        html[data-text-size="medium"] .text-base {
            font-size: 1.05rem !important;
        }

        html[data-text-size="large"] .text-xs {
            font-size: 1rem !important;
            line-height: 1.5 !important;
        }

        html[data-text-size="large"] .text-sm {
            font-size: 1.125rem !important;
            line-height: 1.6 !important;
        }

        html[data-text-size="large"] .text-base {
            font-size: 1.2rem !important;
        }

        html[data-text-size="large"] input,
        html[data-text-size="large"] textarea,
        html[data-text-size="large"] button {
            font-size: 1.1rem !important;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen text-gray-800 flex justify-center">

    <div id="app" style="width: 100%; max-width: 480px;"
        class="min-h-screen flex flex-col relative bg-white shadow-xl overflow-hidden">
        <!-- Login Modal -->
        <div id="loginModal" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm space-y-6">
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-gray-800">„É≠„Ç∞„Ç§„É≥</h2>
                    <p class="text-sm text-gray-500 mt-1">„Çπ„Çø„ÉÉ„ÉïÊÉÖÂ†±„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">„É¶„Éº„Ç∂„ÉºID</label>
                        <input type="text" id="loginEmail"
                            class="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500"
                            placeholder="ex: nakahara">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                        <input type="password" id="loginPass"
                            class="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                </div>
                <div id="loginError" class="text-red-500 text-sm text-center min-h-[1.25rem]"></div>
                <button onclick="doLogin()" id="loginBtn"
                    class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transform transition-transform active:scale-95">
                    „É≠„Ç∞„Ç§„É≥
                </button>
            </div>
        </div>
        <!-- Header -->
        <!-- Header -->
        <header class="bg-blue-600 text-white p-4 shadow-md z-10 sticky top-0 flex items-center justify-between">
            <h1 class="text-xl font-bold tracking-wider">‰øùËÇ≤Êó•Â†±</h1>
            <div class="flex items-center gap-3">
                <span id="headerUserName" class="text-sm font-medium opacity-90"></span>
                <button onclick="openSettings()"
                    class="p-2 bg-white/20 hover:bg-white/30 rounded-full transition-colors" title="Ë®≠ÂÆö">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
                <button onclick="doLogout()" class="p-2 bg-white/20 hover:bg-white/30 rounded-full transition-colors"
                    title="„É≠„Ç∞„Ç¢„Ç¶„Éà">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                        </path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow p-4 overflow-y-auto pb-24">

            <!-- Filters -->
            <div class="mb-6 space-y-3">
                <div class="flex gap-2">
                    <div class="relative flex-grow">
                        <input type="text" id="searchInput" placeholder="È°ßÂÆ¢Âêç„ÅßÊ§úÁ¥¢..."
                            class="w-full pl-10 pr-4 py-3 rounded-xl border-none ring-1 ring-gray-200 focus:ring-2 focus:ring-blue-500 bg-gray-50 text-base shadow-sm transition-all"
                            oninput="filterCustomers()">
                        <svg class="w-5 h-5 absolute left-3 top-3.5 text-gray-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>

                </div>

                <div class="relative">
                    <select id="cityFilter" onchange="filterCustomers()"
                        class="w-full appearance-none pl-4 pr-10 py-3 rounded-xl border-none ring-1 ring-gray-200 focus:ring-2 focus:ring-blue-500 bg-gray-50 text-base shadow-sm transition-all">
                        <option value="">ÂÖ®„Å¶„ÅÆÂú∞Âüü</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                            <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Customer List -->
            <div id="customerList" class="space-y-3">
                <!-- Loading State -->
                <div class="flex justify-center py-8">
                    <div class="w-8 h-8 rounded-full border-4 border-gray-200 loading-spinner"></div>
                </div>
            </div>

        </main>

        <!-- Report Modal (Overlay) -->
        <div id="reportModal"
            class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end sm:items-center justify-center transition-opacity opacity-0">
            <div
                class="bg-white w-full max-w-md h-[90vh] sm:h-auto sm:max-h-[85vh] sm:rounded-2xl rounded-t-2xl shadow-2xl flex flex-col transform transition-transform translate-y-full">

                <!-- Modal Header -->
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
                    <div>
                        <h2 class="font-bold text-lg text-gray-800" id="modalCustomerName">Customer Name</h2>
                        <p class="text-xs text-gray-500" id="modalCustomerAddress">Address</p>
                    </div>
                    <button onclick="closeModal()"
                        class="p-2 hover:bg-gray-200 rounded-full text-gray-500">&times;</button>
                </div>

                <!-- Tabs -->
                <div class="flex border-b border-gray-200">
                    <button onclick="switchMode('daily')" id="tabDaily"
                        class="flex-1 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600 transition-colors">‰øùËÇ≤Êó•Â†±</button>
                    <button onclick="switchMode('accident')" id="tabAccident"
                        class="flex-1 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent transition-colors">‰∫ãÊïÖÂ†±Âëä</button>
                </div>

                <!-- Family Selector -->
                <div id="familySelectorContainer" class="px-4 pt-3 pb-1 bg-blue-50">
                    <label class="block text-xs font-bold text-gray-600 mb-1">ÂØæË±°„ÅÆ„ÅäÂ≠êÊßò</label>
                    <select id="familySelector" onchange="onFamilySelect()"
                        class="w-full p-2 text-sm border-gray-300 rounded mb-2">
                        <option value="">(ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ)</option>
                    </select>
                    <div id="familyInfoBox" class="hidden mb-2 flex items-stretch gap-2">
                        <div id="allergyContainer" class="hidden flex-1 min-w-0">
                            <p id="familyAllergy"
                                class="h-full flex items-center justify-center text-red-600 font-bold text-base bg-red-50 p-2 rounded-lg border border-red-100 shadow-sm text-center break-words">
                            </p>
                        </div>
                        <p id="familyInfo"
                            class="hidden flex-1 min-w-0 text-xs text-gray-700 bg-yellow-50 p-2 rounded border border-yellow-100 break-words flex items-center">
                        </p>
                    </div>
                </div>

                <!-- Modal Body -->
                <div class="p-4 overflow-y-auto flex-grow space-y-4">
                    <!-- Date (Shared) -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between bg-gray-50 p-2 rounded-lg border border-gray-300">
                            <button onclick="changeDate(-1)"
                                class="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <div class="text-base font-bold text-gray-800" id="currentDateDisplay">
                                <!-- JS will populate -->
                            </div>
                            <button onclick="changeDate(1)"
                                class="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors"
                                id="nextDateBtn">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Time (Shared) -->
                    <div class="grid grid-cols-1 gap-4">
                        <!-- Start Time -->
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">ÈñãÂßãÊôÇÈñì/Áô∫ÁîüÊôÇÈñì</label>
                            <div class="flex items-center gap-2">
                                <select id="startHour" class="flex-1 p-2 rounded-lg border border-gray-300 bg-gray-50"
                                    onchange="autoSetEndTime()">
                                    <!-- Populated by JS -->
                                </select>
                                <span class="text-gray-400">:</span>
                                <select id="startMinute" class="flex-1 p-2 rounded-lg border border-gray-300 bg-gray-50"
                                    onchange="autoSetEndTime()">
                                    <option value="00">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                            </div>
                        </div>

                        <!-- End Time -->
                        <div id="endTimeContainer">
                            <label class="block text-xs font-medium text-gray-500 mb-1">ÁµÇ‰∫ÜÊôÇÈñì</label>
                            <div class="flex items-center gap-2">
                                <select id="endHour" class="flex-1 p-2 rounded-lg border border-gray-300 bg-gray-50">
                                    <!-- Populated by JS -->
                                </select>
                                <span class="text-gray-400">:</span>
                                <select id="endMinute" class="flex-1 p-2 rounded-lg border border-gray-300 bg-gray-50">
                                    <option value="00">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Assessment Section (Compact) -->
                    <div id="assessmentSection"
                        class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4 mb-4 p-3 bg-gray-50 rounded-lg border border-gray-100">
                        <!-- Risk -->
                        <div>
                            <div class="flex items-center gap-1 mb-1">
                                <label class="text-xs font-bold text-gray-600">Áî£Âæå„ÅÜ„Å§„ÉªËôêÂæÖ„É™„Çπ„ÇØË©ï‰æ°</label>
                                <button onclick="showAssessmentHint('risk')" class="text-gray-400 hover:text-blue-500">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="flex gap-0.5" id="star-risk">
                                    <button onclick="setRating('risk', 1)"
                                        class="text-xl text-gray-300 hover:scale-110 focus:outline-none">‚òÖ</button>
                                    <button onclick="setRating('risk', 2)"
                                        class="text-xl text-gray-300 hover:scale-110 focus:outline-none">‚òÖ</button>
                                    <button onclick="setRating('risk', 3)"
                                        class="text-xl text-gray-300 hover:scale-110 focus:outline-none">‚òÖ</button>
                                    <button onclick="setRating('risk', 4)"
                                        class="text-xl text-gray-300 hover:scale-110 focus:outline-none">‚òÖ</button>
                                    <button onclick="setRating('risk', 5)"
                                        class="text-xl text-gray-300 hover:scale-110 focus:outline-none">‚òÖ</button>
                                </div>
                                <div id="label-risk" class="text-xs font-bold text-gray-600"></div>
                            </div>
                        </div>

                        <!-- ES -->
                        <div>
                            <div class="flex items-center gap-1 mb-1">
                                <label class="text-xs font-bold text-gray-600">ÂæìÊ•≠Âì°Ê∫ÄË∂≥Â∫¶(ES)</label>
                                <button onclick="showAssessmentHint('es')" class="text-gray-400 hover:text-blue-500">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="flex gap-0.5" id="star-es">
                                    <button onclick="setRating('es', 1)"
                                        class="text-xl text-gray-300 hover:scale-110 focus:outline-none">‚òÖ</button>
                                    <button onclick="setRating('es', 2)"
                                        class="text-xl text-gray-300 hover:scale-110 focus:outline-none">‚òÖ</button>
                                    <button onclick="setRating('es', 3)"
                                        class="text-xl text-gray-300 hover:scale-110 focus:outline-none">‚òÖ</button>
                                    <button onclick="setRating('es', 4)"
                                        class="text-xl text-gray-300 hover:scale-110 focus:outline-none">‚òÖ</button>
                                    <button onclick="setRating('es', 5)"
                                        class="text-xl text-gray-300 hover:scale-110 focus:outline-none">‚òÖ</button>
                                </div>
                                <div id="label-es" class="text-xs font-bold text-gray-600"></div>
                            </div>
                        </div>
                    </div>



                    <!-- Input -->
                    <div>
                        <!-- Incident Type Selector -->
                        <div id="accidentTypeSelector" class="hidden mb-2">
                            <div class="flex gap-4 p-2 bg-gray-50 rounded-lg border border-gray-100">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="accType" value="‰∫ãÊïÖÂ†±Âëä" checked
                                        onchange="updateAccidentPlaceholder()"
                                        class="w-4 h-4 text-red-600 focus:ring-red-500 border-gray-300">
                                    <span class="text-sm font-bold text-gray-700">‰∫ãÊïÖÂ†±Âëä</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="accType" value="„Éí„É§„É™„Éè„ÉÉ„Éà"
                                        onchange="updateAccidentPlaceholder()"
                                        class="w-4 h-4 text-orange-500 focus:ring-orange-400 border-gray-300">
                                    <span class="text-sm font-bold text-gray-700">„Éí„É§„É™„Éè„ÉÉ„Éà</span>
                                </label>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-xs font-medium text-gray-500">„É°„É¢ (Èü≥Â£∞ÂÖ•Âäõ„Å™„Å©„ÅßÂÖ•Âäõ)</label>
                            <div class="flex gap-2">
                                <button onclick="toggleHint()" id="hintBtn"
                                    class="hidden text-xs bg-indigo-50 hover:bg-indigo-100 text-indigo-600 px-2 py-1 rounded-md flex items-center gap-1 transition-colors">
                                    üí° Êõ∏„ÅçÊñπ„ÅÆ„Éí„É≥„Éà
                                </button>
                                <button onclick="startVoiceInput()" id="micBtn"
                                    class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-2 py-1 rounded-md flex items-center gap-1 transition-colors">
                                    <span id="micIcon">üé§</span> <span>Èü≥Â£∞ÂÖ•Âäõ</span>
                                </button>
                            </div>
                        </div>
                        <textarea id="reportInput" rows="6"
                            class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 transition-all resize-none text-base"></textarea>


                        <!-- Warnings Area -->
                        <div id="warningsArea"
                            class="hidden mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-700">
                            <strong>‚ö†Ô∏è ÊÉÖÂ†±‰∏çË∂≥:</strong> <span id="warningsList"></span>
                        </div>



                        <!-- Image Upload Section -->
                        <div id="imageUploadSection" class="mt-4 border-t pt-3">
                            <label class="block text-xs font-medium text-gray-500 mb-2">È†òÂèéÊõ∏„ÉªÊ∑ª‰ªòÁîªÂÉè (ÊúÄÂ§ß6Êûö)</label>
                            <div class="flex flex-wrap gap-2 items-start">
                                <!-- Previews -->
                                <div id="imagePreviewContainer" class="flex flex-wrap gap-2">
                                    <!-- Populated by JS -->
                                </div>

                                <!-- Add Button -->
                                <!-- Add Button (Camera) -->
                                <button onclick="triggerCamera()" id="addCameraBtn"
                                    class="w-20 h-20 border-2 border-dashed border-blue-300 rounded-xl flex flex-col items-center justify-center text-blue-500 hover:bg-blue-50 transition-colors bg-white">
                                    <svg class="w-8 h-8 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z">
                                        </path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    <span class="text-[10px] font-bold">„Ç´„É°„É©ÊíÆÂΩ±</span>
                                </button>

                                <!-- Add Button (Gallery) -->
                                <button onclick="triggerGallery()" id="addGalleryBtn"
                                    class="w-20 h-20 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center text-gray-400 hover:text-gray-600 hover:border-gray-400 transition-colors bg-gray-50">
                                    <svg class="w-8 h-8 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                    <span class="text-[10px] font-bold">„Ç¢„É´„Éê„É†</span>
                                </button>
                            </div>
                            <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden"
                                onchange="handleFileSelect(this)">
                            <input type="file" id="galleryInput" accept="image/*" multiple class="hidden"
                                onchange="handleFileSelect(this)">
                        </div>
                    </div>

                    <!-- Action -->
                    <button onclick="generateReport()" id="generateBtn"
                        class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transform transition-transform active:scale-95 flex items-center justify-center gap-2">
                        <span>Êó•Â†±„Çí‰ΩúÊàê„Åô„Çã</span>
                    </button>

                    <!-- Daily Report Results -->
                    <div id="resultArea" class="hidden space-y-4 pt-4 border-t">
                        <div class="space-y-1">
                            <h3 class="text-sm font-bold text-gray-700 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-indigo-500"></span>
                                Á§æÂÜÖÂêë„Åë
                                <span id="internalCount" class="text-xs text-gray-500 font-normal ml-2">0ÊñáÂ≠ó</span>
                            </h3>
                            <textarea id="internalResult" rows="10" oninput="updateCharCounts()"
                                class="w-full p-3 bg-white rounded-lg text-sm leading-relaxed text-gray-900 border border-indigo-200 focus:ring-2 focus:ring-indigo-300 shadow-sm"></textarea>
                        </div>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center">
                                <h3 class="text-sm font-bold text-gray-700 flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                    ‰øùË≠∑ËÄÖÂêë„Åë
                                    <span id="customerCount" class="text-xs text-gray-500 font-normal ml-2">0ÊñáÂ≠ó</span>
                                </h3>
                                <button onclick="copyToClipboard('customerResult')"
                                    class="text-xs bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 rounded flex items-center gap-1">
                                    üìã „Ç≥„Éî„Éº
                                </button>
                            </div>
                            <textarea id="customerResult" rows="10" oninput="updateCharCounts()"
                                class="w-full p-3 bg-white rounded-lg text-sm leading-relaxed text-gray-900 border border-green-200 focus:ring-2 focus:ring-green-300 shadow-sm"></textarea>
                        </div>
                    </div>

                    <!-- Accident Report Results -->
                    <div id="accidentResultArea" class="hidden space-y-4 pt-4 border-t">
                        <h3 class="text-sm font-bold text-gray-800 border-b pb-2">‰∫ãÊïÖÂ†±ÂëäÊõ∏„Éâ„É©„Éï„Éà</h3>

                        <div class="space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-gray-500">ÂØæË±°ËÄÖÊ∞èÂêç</label>
                                    <input type="text" id="accTargetName"
                                        class="w-full p-2 rounded border border-gray-300 text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-500">ÁîüÂπ¥ÊúàÊó•</label>
                                    <input type="text" id="accTargetDob"
                                        class="w-full p-2 rounded border border-gray-300 text-sm">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500">Áô∫ÁîüÊó•ÊôÇ</label>
                                <input type="text" id="accOccurrenceTime"
                                    class="w-full p-2 rounded border border-gray-300 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500">Áô∫ÁîüÂ†¥ÊâÄ</label>
                                <input type="text" id="accLocation"
                                    class="w-full p-2 rounded border border-gray-300 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500">‰∫ãÊïÖÂÜÖÂÆπ</label>
                                <input type="text" id="accContent"
                                    class="w-full p-2 rounded border border-gray-300 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500">Áô∫ÁîüÁä∂Ê≥Å</label>
                                <textarea id="accSituation" rows="3"
                                    class="w-full p-2 rounded border border-gray-300 text-sm"></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500">Áô∫ÁîüÊôÇ„ÅÆÂØæÂøú</label>
                                <textarea id="accResponse" rows="3"
                                    class="w-full p-2 rounded border border-gray-300 text-sm"></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500">‰øùË≠∑ËÄÖ„Å∏„ÅÆÂØæÂøú</label>
                                <textarea id="accParentCorrespondence" rows="3"
                                    class="w-full p-2 rounded border border-gray-300 text-sm"></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500">Ë®∫Êñ≠Âêç„Åä„Çà„Å≥Âá¶ÁΩÆÁä∂Ê≥Å</label>
                                <textarea id="accDiagnosis" rows="2"
                                    class="w-full p-2 rounded border border-gray-300 text-sm"></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500">‰ªäÂæå„ÅÆÂØæÂøú</label>
                                <textarea id="accPrevention" rows="3"
                                    class="w-full p-2 rounded border border-gray-300 text-sm"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Shared Save Button -->
                    <div id="saveBtnContainer" class="hidden">
                        <button onclick="saveReport()" id="saveBtn"
                            class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg transform transition-transform active:scale-95">
                            ‰øùÂ≠ò„Åô„Çã
                        </button>
                    </div>

                </div>
            </div>


        </div>

        <!-- Toast Notification -->
        <div id="toast"
            class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg transition-opacity duration-300 opacity-0 pointer-events-none z-50 text-sm font-medium">
            Notification Message
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal"
            class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden flex items-center justify-center transition-opacity opacity-0">
            <div
                class="bg-white w-full max-w-sm mx-4 rounded-xl shadow-xl flex flex-col transform transition-transform scale-95">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                    <h3 class="font-bold text-gray-800">Ë®≠ÂÆö</h3>
                    <button onclick="closeSettings()"
                        class="p-2 hover:bg-gray-200 rounded-full text-gray-500">&times;</button>
                </div>
                <div class="p-6 space-y-6">

                    <!-- Font Size Settings (Radio Layout) -->
                    <div>
                        <h4 class="font-bold text-gray-700 mb-3">ÊñáÂ≠ó„Çµ„Ç§„Ç∫Ë®≠ÂÆö</h4>
                        <div class="space-y-3">
                            <label
                                class="flex items-center space-x-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-200">
                                <input type="radio" name="textSize" value="small" onchange="applyTextSize('small')"
                                    class="w-5 h-5 text-blue-600 focus:ring-blue-500 border-gray-300">
                                <span class="text-xs text-gray-600">Â∞è (Ê®ôÊ∫ñ)</span>
                            </label>
                            <label
                                class="flex items-center space-x-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-200">
                                <input type="radio" name="textSize" value="medium" onchange="applyTextSize('medium')"
                                    class="w-5 h-5 text-blue-600 focus:ring-blue-500 border-gray-300">
                                <span class="text-sm font-bold text-gray-800">‰∏≠ (Â∞ë„ÅóÂ§ß„Åç„Åè)</span>
                            </label>
                            <label
                                class="flex items-center space-x-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-200">
                                <input type="radio" name="textSize" value="large" onchange="applyTextSize('large')"
                                    class="w-5 h-5 text-blue-600 focus:ring-blue-500 border-gray-300">
                                <span class="text-base font-bold text-gray-900">Â§ß (Â§ß„Åç„Åè)</span>
                            </label>
                        </div>
                    </div>

                    <!-- Admin Settings Area -->
                    <div id="adminSettingsArea" class="hidden border-t pt-4">
                        <h4 class="text-sm font-bold text-red-600 mb-3">ÁÆ°ÁêÜËÄÖË®≠ÂÆö</h4>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">LineWorks ÈÄöÁü•ÂÖàID</label>
                            <p class="text-xs text-gray-400 mb-2">„Éà„Éº„ÇØ„É´„Éº„É†ID „Åæ„Åü„ÅØ „É¶„Éº„Ç∂„ÉºID</p>
                            <input type="text" id="settingLwTargetId" placeholder="Loading..."
                                class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500">
                            <p class="text-[10px] text-gray-400 mt-1">‚Äª ÂÖ®„É¶„Éº„Ç∂„ÉºÂÖ±ÈÄö„ÅÆË®≠ÂÆö„Åß„Åô</p>
                        </div>
                    </div>

                </div>
                <div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end">
                    <button onclick="saveSettings()"
                        class="px-4 py-2 bg-blue-600 text-white text-sm font-bold rounded-lg hover:bg-blue-700">‰øùÂ≠ò„Åó„Å¶Èñâ„Åò„Çã</button>
                </div>
            </div>
        </div>

        <!-- Script -->
        <!-- Hint Modal -->
        <div id="hintModal"
            class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center transition-opacity opacity-0">
            <div
                class="bg-white w-full max-w-lg mx-4 rounded-xl shadow-2xl flex flex-col max-h-[80vh] transform transition-transform scale-95">
                <div class="p-4 border-b flex justify-between items-center bg-indigo-50 rounded-t-xl">
                    <h3 id="hintModalTitle" class="font-bold text-gray-800">‰∫ãÊïÖÂ†±ÂëäÊõ∏„ÅÆÊõ∏„ÅçÊñπ„Éí„É≥„Éà</h3>
                    <button onclick="toggleHint()"
                        class="p-2 hover:bg-indigo-100 rounded-full text-indigo-500">&times;</button>
                </div>
                <div class="p-6 overflow-y-auto whitespace-pre-wrap text-sm leading-relaxed text-gray-700"
                    id="hintContent">
                    <!-- Content loaded from JS -->
                </div>
                <div class="p-4 border-t bg-gray-50 rounded-b-xl text-right">
                    <button onclick="toggleHint()"
                        class="px-4 py-2 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700">Èñâ„Åò„Çã</button>
                </div>
            </div>
        </div>



        <script>
            let allCustomers = [];
            let currentCustomer = null;
            let currentStaffName = '';
            let currentReportMode = 'daily'; // 'daily' or 'accident'
            let uiConfig = {};

            let localDataVersion = '0';

            const CACHE_KEY = 'GAS_CUSTOMER_DATA_V2';
            const STAFF_CACHE_KEY = 'GAS_STAFF_SESSION_V3';
            const STAFF_ADMIN_KEY = 'GAS_STAFF_ADMIN';
            const ENC_KEY = 123; // Simple key

            // Initialize
            window.onload = function () {
                // Restore Font Size
                const savedSize = localStorage.getItem('app_text_size') || 'small';
                document.documentElement.setAttribute('data-text-size', savedSize);

                populateHours();
                checkLogin();
                loadUiConfig();
                startVersionPolling();
            };

            function startVersionPolling() {
                // First check for new CSV import on load
                google.script.run.withSuccessHandler(res => {
                    console.log("CSV Auto-Import Check:", res);
                    if (res && res.startsWith("Imported")) {
                        showToast("Êñ∞„Åó„ÅÑ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü", false);
                        reloadData(true); // Force reload immediately
                    } else {
                        checkForUpdates(); // Continue with normal check
                    }
                }).checkAndImportLatestCsv();

                setInterval(checkForUpdates, 60000); // Check every minute
            }

            function checkForUpdates() {
                // Check current version from server
                google.script.run.withSuccessHandler(serverVersion => {
                    if (serverVersion && serverVersion !== localDataVersion) {
                        console.log("New data detected:", serverVersion);
                        showToast("Êñ∞„Åó„ÅÑ„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü„ÄÇÊõ¥Êñ∞„Åó„Å¶„ÅÑ„Åæ„Åô...", false);
                        reloadData(true);
                    }
                }).checkDataVersion();
            }

            // ... loadUiConfig ...
            // ... switchMode ...

            function checkLogin() {
                const savedName = localStorage.getItem(STAFF_CACHE_KEY);
                if (savedName) {
                    currentStaffName = savedName;
                    document.getElementById('headerUserName').textContent = savedName + ' „Åï„Çì';
                    document.getElementById('loginModal').classList.add('hidden');

                    // Admin check


                    loadData(false);
                } else {
                    document.getElementById('loginModal').classList.remove('hidden');
                }
            }

            function loadUiConfig() {
                google.script.run.withSuccessHandler(config => {
                    uiConfig = config;
                    // Apply default placeholder based on current mode defaults or just wait for switch
                    if (currentReportMode === 'daily' && uiConfig.dailyPlaceholder) {
                        document.getElementById('reportInput').placeholder = uiConfig.dailyPlaceholder;
                    }
                }).getUiConfig();
            }

            // --- Assessment Logic ---
            let assessmentRatings = { risk: 0, es: 0 };

            function setRating(type, score) {
                assessmentRatings[type] = score;
                updateStarDisplay(type, score);
            }

            function updateStarDisplay(type, score) {
                const container = document.getElementById(`star-${type}`);
                if (!container) return;
                const buttons = container.querySelectorAll('button');
                buttons.forEach((btn, idx) => {
                    const starVal = idx + 1;
                    if (starVal <= score) {
                        btn.className = "text-2xl text-yellow-400 hover:scale-110 transition-transform focus:outline-none";
                    } else {
                        btn.className = "text-2xl text-gray-300 hover:scale-110 transition-transform focus:outline-none";
                    }
                });

                // Update Label if config loaded
                const labelDiv = document.getElementById(`label-${type}`);
                if (uiConfig.assessments && uiConfig.assessments[type]) {
                    const level = uiConfig.assessments[type].levels.find(l => l.score === score);
                    if (level) {
                        labelDiv.textContent = `${level.label}`;
                    } else {
                        labelDiv.textContent = "";
                    }
                }
            }

            function resetRatings() {
                setRating('risk', 0);
                setRating('es', 0);
            }

            function showAssessmentHint(type) {
                const modal = document.getElementById('hintModal');
                const title = document.getElementById('hintModalTitle');
                const content = document.getElementById('hintContent');

                if (!uiConfig.assessments || !uiConfig.assessments[type]) {
                    showToast("Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø‰∏≠„ÄÅ„Åæ„Åü„ÅØË®≠ÂÆö„Åå„ÅÇ„Çä„Åæ„Åõ„Çì");
                    return;
                }

                const data = uiConfig.assessments[type];
                title.textContent = data.title + " ÊåáÊ®ô";

                // Build Table HTML
                let html = `<table class="w-full text-left border-collapse">`;
                html += `<thead><tr class="border-b bg-gray-50"><th class="p-2 text-xs w-10">Ë©ï‰æ°</th><th class="p-2 text-xs w-20">ÂÆöÁæ©</th><th class="p-2 text-xs">Âà§Êñ≠Âü∫Ê∫ñ</th></tr></thead><tbody>`;

                data.levels.forEach(l => {
                    html += `<tr class="border-b">
                        <td class="p-2 text-lg font-bold text-center text-yellow-500">${l.score}</td>
                        <td class="p-2 text-sm font-bold">${l.label}</td>
                        <td class="p-2 text-xs text-gray-600 whitespace-pre-wrap">${l.desc}</td>
                    </tr>`;
                });
                html += `</tbody></table>`;

                content.innerHTML = html;

                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);
            }

            // --- Date Logic ---
            let reportTargetDate = new Date();

            function updateDateDisplay() {
                const el = document.getElementById('currentDateDisplay');
                if (!el) return;
                const nextBtn = document.getElementById('nextDateBtn');

                const y = reportTargetDate.getFullYear();
                const m = reportTargetDate.getMonth() + 1;
                const d = reportTargetDate.getDate();
                const day = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'][reportTargetDate.getDay()];

                el.textContent = `${y}Âπ¥${m}Êúà${d}Êó•(${day})`;

                // Disable future
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const target = new Date(reportTargetDate);
                target.setHours(0, 0, 0, 0);

                if (target >= today) {
                    nextBtn.disabled = true;
                    nextBtn.classList.add('opacity-30', 'cursor-not-allowed');
                } else {
                    nextBtn.disabled = false;
                    nextBtn.classList.remove('opacity-30', 'cursor-not-allowed');
                }
            }

            function changeDate(offset) {
                const newDate = new Date(reportTargetDate);
                newDate.setDate(newDate.getDate() + offset);

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const check = new Date(newDate);
                check.setHours(0, 0, 0, 0);

                if (offset > 0 && check > today) return; // Prevent future

                reportTargetDate = newDate;
                updateDateDisplay();
            }

            function resetDate() {
                reportTargetDate = new Date();
                updateDateDisplay();
            }

            function openSettings() {
                const modal = document.getElementById('settingsModal');

                // 1. Setup Admin Area visibility
                const isAdmin = localStorage.getItem(STAFF_ADMIN_KEY);
                const adminArea = document.getElementById('adminSettingsArea');

                if (isAdmin === '1' || isAdmin === 'true') {
                    adminArea.classList.remove('hidden');
                    // Load current setting if Admin
                    // To prevent flickering when reopening, only load if placeholder or empty
                    const input = document.getElementById('settingLwTargetId');
                    if (input.value === "" || input.value === "Loading..." || input.value === "Error") {
                        input.value = "Loading...";
                        google.script.run.withSuccessHandler(id => {
                            input.value = id;
                        }).withFailureHandler(e => {
                            input.value = "Error";
                        }).getLwTargetId();
                    }
                } else {
                    adminArea.classList.add('hidden');
                }

                // 2. Setup Font Size Radio Selection
                // Restore old logic: check the radio corresponding to current 'app_text_size'
                const current = localStorage.getItem('app_text_size') || 'small';
                const radio = document.querySelector(`input[name="textSize"][value="${current}"]`);
                if (radio) radio.checked = true;

                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);
            }

            // Restore applyTextSize for Radio Button change event
            function applyTextSize(size) {
                document.documentElement.setAttribute('data-text-size', size);
                localStorage.setItem('app_text_size', size);
            }

            function closeSettings() {
                const modal = document.getElementById('settingsModal');
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }

            function saveSettings() {
                const isAdmin = localStorage.getItem(STAFF_ADMIN_KEY);

                // Only save LineWorks ID if Admin and visible
                if (isAdmin === '1' || isAdmin === 'true') {
                    const newId = document.getElementById('settingLwTargetId').value;
                    if (newId && newId !== "Loading..." && newId !== "Error") {
                        const btn = document.querySelector('#settingsModal button[onclick="saveSettings()"]');
                        const originalText = btn.textContent;
                        btn.disabled = true;
                        btn.textContent = "‰øùÂ≠ò‰∏≠...";

                        google.script.run.withSuccessHandler(res => {
                            btn.disabled = false;
                            btn.textContent = originalText;
                            if (res.success) {
                                showToast(res.message);
                                closeSettings();
                            } else {
                                showToast("‰øùÂ≠òÂ§±Êïó: " + res, true);
                            }
                        }).withFailureHandler(e => {
                            btn.disabled = false;
                            btn.textContent = originalText;
                            showToast("Error: " + e.message, true);
                        }).saveLwTargetId(newId);
                        return; // Async save handles close
                    }
                }

                // If not admin or no changes to admin settings, just close
                showToast("Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü");
                closeSettings();
            }

            function switchMode(mode) {
                currentReportMode = mode;
                const tabDaily = document.getElementById('tabDaily');
                const tabAccident = document.getElementById('tabAccident');
                const hintBtn = document.getElementById('hintBtn');
                const input = document.getElementById('reportInput');
                const typeSelector = document.getElementById('accidentTypeSelector');
                const imageSection = document.getElementById('imageUploadSection');

                // UI Toggle
                if (mode === 'daily') {
                    tabDaily.className = "flex-1 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600 transition-colors";
                    tabAccident.className = "flex-1 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent transition-colors";

                    document.getElementById('endTimeContainer').classList.remove('hidden');
                    document.getElementById('familySelectorContainer').classList.add('hidden'); // Hide Family Selector
                    document.getElementById('generateBtn').querySelector('span').textContent = 'Êó•Â†±„Çí‰ΩúÊàê„Åô„Çã';

                    hintBtn.classList.add('hidden');
                    typeSelector.classList.add('hidden');

                    if (imageSection) imageSection.classList.remove('hidden');

                    input.placeholder = uiConfig.dailyPlaceholder || "";

                    // Show/Hide results based on previous state
                    const hasDailyResult = document.getElementById('internalResult').value !== '';
                    if (hasDailyResult) {
                        document.getElementById('resultArea').classList.remove('hidden');
                        document.getElementById('saveBtnContainer').classList.remove('hidden');
                    } else {
                        document.getElementById('resultArea').classList.add('hidden');
                        document.getElementById('saveBtnContainer').classList.add('hidden');
                    }
                    document.getElementById('accidentResultArea').classList.add('hidden');

                } else {
                    tabDaily.className = "flex-1 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent transition-colors";
                    tabAccident.className = "flex-1 py-3 text-sm font-medium text-red-600 border-b-2 border-red-600 transition-colors";

                    document.getElementById('endTimeContainer').classList.add('hidden');
                    document.getElementById('familySelectorContainer').classList.remove('hidden'); // Show Family Selector
                    document.getElementById('generateBtn').querySelector('span').textContent = '‰∫ãÊïÖÂ†±ÂëäÊõ∏„Çí‰ΩúÊàê„Åô„Çã';

                    hintBtn.classList.remove('hidden');
                    typeSelector.classList.remove('hidden');

                    if (imageSection) imageSection.classList.add('hidden');

                    // Update Placeholder based on selection
                    updateAccidentPlaceholder();

                    document.getElementById('resultArea').classList.add('hidden');

                    const hasAccidentResult = document.getElementById('accOccurrenceTime').value !== '';
                    if (hasAccidentResult) {
                        document.getElementById('accidentResultArea').classList.remove('hidden');
                        document.getElementById('saveBtnContainer').classList.remove('hidden');
                    } else {
                        document.getElementById('accidentResultArea').classList.add('hidden');
                        document.getElementById('saveBtnContainer').classList.add('hidden');
                    }
                }
            }

            function updateAccidentPlaceholder() {
                if (currentReportMode !== 'accident') return;
                // Always use Accident placeholder even for Hiyarihatto
                const input = document.getElementById('reportInput');
                input.placeholder = uiConfig.accidentPlaceholder || "";
            }

            function toggleHint() {
                const modal = document.getElementById('hintModal');
                if (modal.classList.contains('hidden')) {
                    let content = uiConfig.accidentHint || "Loading...";
                    let title = "‰∫ãÊïÖÂ†±ÂëäÊõ∏„ÅÆÊõ∏„ÅçÊñπ„Éí„É≥„Éà";

                    // If in accident mode and Hiyarihatto is selected, use Hiyari placeholder text as hint
                    if (currentReportMode === 'accident') {
                        const typeRadio = document.querySelector('input[name="accType"]:checked');
                        if (typeRadio && typeRadio.value === '„Éí„É§„É™„Éè„ÉÉ„Éà') {
                            content = uiConfig.hiyariPlaceholder || "„Éí„É§„É™„Éè„ÉÉ„Éà„ÅÆÁä∂Ê≥Å„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...";
                            title = "„Éí„É§„É™„Éè„ÉÉ„Éà„ÅÆÊõ∏„ÅçÊñπ„Éí„É≥„Éà";
                        }
                    }

                    document.getElementById('hintContent').textContent = content;
                    document.getElementById('hintModalTitle').textContent = title;
                    modal.classList.remove('hidden');
                    setTimeout(() => modal.classList.remove('opacity-0'), 10);
                } else {
                    modal.classList.add('opacity-0');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            }

            function doLogin() {
                const email = document.getElementById('loginEmail').value;
                const pass = document.getElementById('loginPass').value;
                const btn = document.getElementById('loginBtn');
                const err = document.getElementById('loginError');

                if (!email || !pass) {
                    err.textContent = "ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
                    return;
                }

                btn.disabled = true;
                btn.textContent = "Á¢∫Ë™ç‰∏≠...";
                err.textContent = "";

                google.script.run.withSuccessHandler(res => {
                    btn.disabled = false;
                    btn.textContent = "„É≠„Ç∞„Ç§„É≥";
                    if (res.success) {
                        currentStaffName = res.name;
                        localStorage.setItem(STAFF_CACHE_KEY, res.name);

                        // Admin Handling
                        if (res.isAdmin) {
                            localStorage.setItem(STAFF_ADMIN_KEY, 'true');
                        } else {
                            localStorage.removeItem(STAFF_ADMIN_KEY);
                        }

                        document.getElementById('headerUserName').textContent = res.name + ' „Åï„Çì';
                        document.getElementById('loginModal').classList.add('hidden');
                        loadData(false);
                    } else {
                        err.textContent = res.message;
                    }
                }).withFailureHandler(e => {
                    btn.disabled = false;
                    btn.textContent = "„É≠„Ç∞„Ç§„É≥";
                    err.textContent = "Error: " + e.message;
                }).verifyLogin(email, pass);
            }

            function doLogout() {
                localStorage.removeItem(STAFF_CACHE_KEY);
                localStorage.removeItem(STAFF_ADMIN_KEY);
                location.reload();
            }



            function populateHours() {
                const hours = [];
                for (let i = 0; i < 24; i++) {
                    const val = i.toString().padStart(2, '0');
                    hours.push(`<option value="${val}">${val}</option>`);
                }
                document.getElementById('startHour').innerHTML = hours.join('');
                document.getElementById('endHour').innerHTML = hours.join('');
                // Set default
                document.getElementById('startHour').value = "09";
                document.getElementById('endHour').value = "11";
            }

            // ... encryption ...
            function encrypt(text) {
                try {
                    const chars = text.split('').map(c => String.fromCharCode(c.charCodeAt(0) ^ ENC_KEY));
                    return btoa(unescape(encodeURIComponent(chars.join(''))));
                } catch (e) { console.error(e); return null; }
            }
            function decrypt(encoded) {
                try {
                    const chars = decodeURIComponent(escape(atob(encoded))).split('');
                    return chars.map(c => String.fromCharCode(c.charCodeAt(0) ^ ENC_KEY)).join('');
                } catch (e) { console.error(e); return null; }
            }

            // ... data loading ...
            function reloadData(force) { loadData(force); }
            function loadData(force = false) {
                const container = document.getElementById('customerList');
                // Only show spinner if we don't have data or forcing
                if (force || allCustomers.length === 0) {
                    container.innerHTML = '<div class="flex justify-center py-8"><div class="w-8 h-8 rounded-full border-4 border-gray-200 loading-spinner"></div></div>';
                }

                const refreshBtn = document.getElementById('refreshBtn');
                if (refreshBtn) refreshBtn.classList.add('animate-spin');

                if (!force) {
                    const cached = localStorage.getItem(CACHE_KEY);
                    if (cached) {
                        const decrypted = decrypt(cached);
                        if (decrypted) {
                            try {
                                const data = JSON.parse(decrypted);
                                onDataLoaded(data, true);
                                if (refreshBtn) refreshBtn.classList.remove('animate-spin');
                                return;
                            } catch (e) { console.error("Cache parse error", e); }
                        }
                    }
                }

                google.script.run.withSuccessHandler((data) => {
                    try {
                        const json = JSON.stringify(data);
                        const encrypted = encrypt(json);
                        if (encrypted) localStorage.setItem(CACHE_KEY, encrypted);

                        onDataLoaded(data, false);
                        if (force) showToast('„Éá„Éº„Çø„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
                    } catch (e) {
                        console.error("Success Handler Error:", e);
                        showToast("„Éá„Éº„ÇøÂá¶ÁêÜ„Ç®„É©„Éº: " + e.message, true);
                    } finally {
                        if (refreshBtn) refreshBtn.classList.remove('animate-spin');
                    }
                }).withFailureHandler((e) => {
                    onError(e);
                    if (refreshBtn) refreshBtn.classList.remove('animate-spin');
                }).getData();
            }

            function onDataLoaded(data, fromCache) {
                allCustomers = data.customers;
                if (data.version) {
                    localDataVersion = data.version;
                }
                const select = document.getElementById('cityFilter');
                select.innerHTML = '<option value="">ÂÖ®„Å¶„ÅÆÂú∞Âüü</option>';
                populateCityFilter(data.cities);
                renderCustomers(allCustomers);
            }
            function onError(e) { showToast('Error: ' + e.message, true); }
            function populateCityFilter(cities) {
                const select = document.getElementById('cityFilter');
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    select.appendChild(option);
                });
            }
            function renderCustomers(customers) {
                const container = document.getElementById('customerList');
                container.innerHTML = '';

                if (customers.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-8">Ë©≤ÂΩì„Åô„ÇãÈ°ßÂÆ¢„Åå„ÅÑ„Åæ„Åõ„Çì</div>';
                    return;
                }

                customers.forEach(c => {
                    const el = document.createElement('div');
                    el.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer hover:shadow-md transition-shadow active:bg-gray-50';
                    el.onclick = () => openModal(c);
                    el.innerHTML = `
                    <div class="flex-grow">
                        <h3 class="font-bold text-gray-800 text-lg">${c.name}</h3>
                        <p class="text-sm text-gray-500 flex items-center gap-1">
                            <span class="inline-block px-2 py-0.5 bg-gray-100 rounded text-xs">${c.city}</span>
                        </p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex flex-col gap-2 items-end z-10 relative">
                            <button onclick="event.stopPropagation(); showCustomerDetail('${c.id}')" 
                                class="px-3 py-1.5 text-xs font-bold text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg border border-blue-200 transition-colors">
                                È°ßÂÆ¢ÊÉÖÂ†±
                            </button>
                            <button onclick="event.stopPropagation(); showCustomerHistory('${c.id}')" 
                                class="px-3 py-1.5 text-xs font-bold text-orange-600 bg-orange-50 hover:bg-orange-100 rounded-lg border border-orange-200 transition-colors">
                                Ê¥ªÂãïË®òÈå≤
                            </button>
                        </div>
                        <div class="text-blue-500">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </div>
                    </div>
                `;
                    container.appendChild(el);
                });
            }
            function filterCustomers() {
                const city = document.getElementById('cityFilter').value;
                const search = document.getElementById('searchInput').value.toLowerCase();
                const filtered = allCustomers.filter(c => {
                    const matchesCity = city ? c.city === city : true;
                    const matchesSearch = c.name.toLowerCase().includes(search);
                    return matchesCity && matchesSearch;
                });
                renderCustomers(filtered);
            }

            // Customer Detail Logic
            function showCustomerDetail(id) {
                const c = allCustomers.find(x => x.id === id);
                if (!c) return;

                // Family
                const famContainer = document.getElementById('detailFamilyList');
                if (c.family && c.family.length > 0) {
                    famContainer.innerHTML = c.family.map(f => `
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <div class="font-bold text-gray-800">${f.name} <span class="text-xs font-normal text-gray-500 ml-1">${f.dob}</span></div>
                        <div class="text-xs text-red-600 mt-1">„Ç¢„É¨„É´„ÇÆ„Éº: ${f.allergy || '„Å™„Åó'}</div>
                        <div class="text-xs text-gray-600 mt-0.5 text-wrap break-words">${f.info || ''}</div>
                    </div>
                 `).join('');
                } else {
                    famContainer.innerHTML = '<p class="text-gray-400 text-xs">ÁôªÈå≤„Å™„Åó</p>';
                }

                // Customer Details
                const table = document.getElementById('detailCustomerTable');
                let html = '';
                if (c.details && Array.isArray(c.details)) {
                    c.details.forEach(item => {
                        const key = item.key;
                        const val = item.value;

                        // Exclude ID and Password (already filtered in backend but safe check)
                        if (key === 'È°ßÂÆ¢ID' || key === '„Éë„Çπ„ÉØ„Éº„Éâ' || key === 'Customer ID') return;

                        let content = `<span class="break-words">${val}</span>`;

                        // Address Map Logic
                        if (key.includes('‰ΩèÊâÄ') && !key.includes('2') && val) {
                            let mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(val)}`;
                            if (c.lat && c.lng) {
                                mapUrl = `https://www.google.com/maps/search/?api=1&query=${c.lat},${c.lng}`;
                            }
                            content = `
                            <div class="flex items-start gap-2">
                                <span class="break-words flex-grow">${val}</span>
                                <a href="${mapUrl}" target="_blank" class="flex-shrink-0 px-2 py-1 bg-blue-100 text-blue-600 text-xs rounded hover:bg-blue-200 flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                    Map
                                </a>
                            </div>
                         `;
                        }
                        // Email Logic
                        else if (key.includes('„É°„Éº„É´') && val) {
                            content = `
                            <div class="flex items-start gap-2">
                                <span class="break-words flex-grow">${val}</span>
                                <a href="mailto:${val}" target="_top" class="flex-shrink-0 px-2 py-1 bg-teal-100 text-teal-700 text-xs rounded hover:bg-teal-200 flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                    „É°„Éº„É´
                                </a>
                            </div>
                         `;
                        }
                        // Phone Logic
                        else if (key.includes('ÈõªË©±') && val) {
                            // Clean phone number for tel link (remove non-digits?)
                            // Usually tel: accepts hyphens, but let's keep it robust.
                            // But simple is fine: tel:${val} usually works if format is standard.
                            content = `
                            <div class="flex items-start gap-2">
                                <span class="break-words flex-grow">${val}</span>
                                <a href="tel:${val}" target="_top" class="flex-shrink-0 px-2 py-1 bg-green-100 text-green-700 text-xs rounded hover:bg-green-200 flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                                    ÈõªË©±
                                </a>
                            </div>
                         `;
                        }

                        html += `
                        <div class="border-b border-gray-100 pb-2">
                            <div class="text-xs text-gray-500 mb-0.5">${key}</div>
                            <div class="text-gray-800 text-sm leading-relaxed">${content}</div>
                        </div>
                     `;
                    });
                } else if (c.details) {
                    // Fallback for cached old data format
                    for (const [key, val] of Object.entries(c.details)) {
                        // Same logic as above for fallback
                        if (key === 'È°ßÂÆ¢ID' || key === '„Éë„Çπ„ÉØ„Éº„Éâ' || key === 'Customer ID') continue;
                        let content = `<span class="break-words">${val}</span>`;
                        if (key.includes('‰ΩèÊâÄ') && !key.includes('2')) {
                            /* Minimal Map fallback logic could go here or just skip for fallback */
                            content = `<span class="break-words">${val}</span>`;
                        }
                        html += `
                        <div class="border-b border-gray-100 pb-2">
                            <div class="text-xs text-gray-500 mb-0.5">${key}</div>
                            <div class="text-gray-800 text-sm leading-relaxed">${content}</div>
                        </div>
                     `;
                    }
                }
                table.innerHTML = html;

                const modal = document.getElementById('customerDetailModal');
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);

                // Load History
                loadCustomerHistory(id);
            }

            function closeCustomerDetail() {
                const modal = document.getElementById('customerDetailModal');
                modal.classList.add('opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    document.getElementById('detailReportTimeline').innerHTML = '<div class="text-xs text-gray-400 py-4 pl-4">Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...</div>';
                    document.getElementById('historyLoading').classList.add('hidden');
                }, 300);
            }

            // Cache Globals
            let currentDetailId = null;
            const historyCache = {};

            function loadCustomerHistory(customerId, forceRefresh = false) {
                currentDetailId = customerId;
                const timeline = document.getElementById('detailReportTimeline');
                const loader = document.getElementById('historyLoading');

                // Use Cache if available and not forced
                if (!forceRefresh && historyCache[customerId]) {
                    renderHistoryTimeline(historyCache[customerId]);
                    return;
                }

                timeline.innerHTML = '';
                loader.classList.remove('hidden');

                google.script.run.withSuccessHandler(reports => {
                    loader.classList.add('hidden');
                    historyCache[customerId] = reports || []; // Cache Result

                    if (!reports || reports.length === 0) {
                        timeline.innerHTML = '<div class="text-xs text-gray-400 py-4 pl-4">Â±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                        return;
                    }
                    renderHistoryTimeline(reports);
                }).withFailureHandler(e => {
                    loader.classList.add('hidden');
                    timeline.innerHTML = `<div class="text-xs text-red-400 py-4 pl-4">Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${e.message}</div>`;
                }).getCustomerReports(customerId);
            }

            function renderHistoryTimeline(reports) {
                const timeline = document.getElementById('detailReportTimeline');
                let html = '';

                reports.forEach((r, idx) => {
                    const isAccident = r.type === 'accident';

                    let title = '‰øùËÇ≤Êó•Â†±';
                    let colorClass = 'bg-blue-500';

                    if (isAccident) {
                        title = r.subtype || '‰∫ãÊïÖÂ†±Âëä';
                        if (title.includes('„Éí„É§„É™')) {
                            colorClass = 'bg-orange-400';
                        } else {
                            colorClass = 'bg-red-500';
                        }
                    }

                    const dateStr = r.timestamp.split(' ')[0];
                    const timeStr = r.timestamp.split(' ')[1] || '';
                    const uid = `rep-${idx}`;

                    // Tabs Buttons
                    let tabsHtml = `
                    <button onclick="switchReportTab('${uid}', 'original')" id="btn-${uid}-original" class="px-2 py-1 rounded-t text-gray-500 hover:bg-gray-200 transition-colors">ÂéüÊú¨</button>
                    <button onclick="switchReportTab('${uid}', 'internal')" id="btn-${uid}-internal" class="px-2 py-1 rounded-t font-bold bg-white border-x border-t border-gray-200 text-blue-600">Á§æÂÜÖÂêë„Åë</button>
                `;

                    // Add Customer Tab only for non-accidents
                    if (!isAccident) {
                        tabsHtml += `<button onclick="switchReportTab('${uid}', 'customer')" id="btn-${uid}-customer" class="px-2 py-1 rounded-t text-gray-500 hover:bg-gray-200 transition-colors">‰øùË≠∑ËÄÖÂêë„Åë</button>`;
                    }

                    html += `
                    <div class="relative pl-6 pb-6 group transition-all duration-300 hover:pl-7">
                        <!-- Dot -->
                        <div class="absolute -left-[9px] top-1 w-5 h-5 rounded-full border-4 border-white ${colorClass} shadow-sm z-10"></div>
                        
                        <!-- Card -->
                        <div class="bg-gray-50 rounded-lg p-3 border border-gray-100 shadow-sm hover:shadow-md transition-shadow">
                            <!-- Header -->
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-grow flex flex-wrap items-center gap-y-1">
                                    <span class="text-xs font-bold text-white px-2 py-0.5 rounded ${colorClass} mr-2">${title}</span>
                                    <span class="text-sm font-bold text-gray-700">${dateStr}</span>
                                    <span class="text-xs text-gray-500 ml-1 mr-2">${timeStr}</span>
                                    
                                    ${(r.risk) ? `<span class="text-xs font-bold bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded border border-yellow-200 whitespace-nowrap mr-1">„É™„Çπ„ÇØ:${"‚òÖ".repeat(Number(r.risk) || 0) + "‚òÜ".repeat(5 - (Number(r.risk) || 0))}</span>` : ''}
                                    ${(r.es) ? `<span class="text-xs font-bold bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded border border-indigo-200 whitespace-nowrap">ES:${"‚òÖ".repeat(Number(r.es) || 0) + "‚òÜ".repeat(5 - (Number(r.es) || 0))}</span>` : ''}
                                </div>
                                <div class="text-xs text-gray-400 flex items-center gap-1 flex-shrink-0">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                    ${r.staff || '‰∏çÊòé'}
                                </div>
                            </div>

                            <!-- Controls (Tabs) -->
                            <div class="flex space-x-1 mb-2 border-b border-gray-200 text-xs">
                                ${tabsHtml}
                            </div>

                            <!-- Content Areas -->
                            <div class="text-sm text-gray-700 leading-relaxed min-h-[60px]">
                                <div id="content-${uid}-original" class="hidden whitespace-pre-wrap">${r.original || '(„Å™„Åó)'}</div>
                                <div id="content-${uid}-internal" class="whitespace-pre-wrap">${r.internal || '(„Å™„Åó)'}</div>
                                <div id="content-${uid}-customer" class="hidden whitespace-pre-wrap">${r.customer || '(„Å™„Åó)'}</div>
                            </div>
                        </div>
                    </div>
                `;
                });

                timeline.innerHTML = html;
            }

            // --- History Modal Functions ---
            function showCustomerHistory(id) {
                const modal = document.getElementById('customerHistoryModal');
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);
                /* Reset visual state */
                const inner = modal.querySelector('div');
                inner.classList.remove('scale-95');
                inner.classList.add('transition-all');

                loadCustomerHistory(id);
            }

            function closeCustomerHistory() {
                const modal = document.getElementById('customerHistoryModal');
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }

            function switchReportTab(uid, type) {
                // Hide all contents
                ['original', 'internal', 'customer'].forEach(t => {
                    const c = document.getElementById(`content-${uid}-${t}`);
                    if (c) c.classList.add('hidden');

                    const btn = document.getElementById(`btn-${uid}-${t}`);
                    // Reset button styles
                    if (btn) btn.className = 'px-2 py-1 rounded-t text-gray-500 hover:bg-gray-200 transition-colors';
                });

                // Show selected
                const target = document.getElementById(`content-${uid}-${type}`);
                if (target) target.classList.remove('hidden');

                const activeBtn = document.getElementById(`btn-${uid}-${type}`);
                if (activeBtn) activeBtn.className = 'px-2 py-1 rounded-t font-bold bg-white border-x border-t border-gray-200 text-blue-600';
            }

            // Modal Logic
            const modal = document.getElementById('reportModal');
            const modalContent = modal.querySelector('div');

            function calculateAge(dobStr) {
                // "yyyy/MM/dd"
                if (!dobStr) return "";
                const parts = dobStr.split('/');
                if (parts.length !== 3) return "";

                const birthDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                const today = new Date();

                let years = today.getFullYear() - birthDate.getFullYear();
                let months = today.getMonth() - birthDate.getMonth();

                if (today.getDate() < birthDate.getDate()) {
                    months--;
                }
                if (months < 0) {
                    years--;
                    months += 12;
                }

                // To half-width digits
                const toFullWidth = (n) => String(n).replace(/[0-9]/g, s => String.fromCharCode(s.charCodeAt(0) + 0xFEE0));
                // User example shows Full Width numbers: "ÔºêÊ≠≥Ôºì„ÅãÊúà"
                // Wait, standard JP usage often uses half-width but user requested "ÔºêÊ≠≥Ôºì„ÅãÊúà".
                // I will use full-width for numbers to match request.
                return `Ôºà${toFullWidth(years)}Ê≠≥${toFullWidth(months)}„ÅãÊúàÔºâ`;
            }

            function openModal(customer) {
                currentCustomer = customer;
                document.getElementById('modalCustomerName').textContent = customer.name;
                document.getElementById('modalCustomerAddress').textContent = customer.address;

                // Populate Family Selector
                const famSelect = document.getElementById('familySelector');
                famSelect.innerHTML = '<option value="">(ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ)</option>';
                if (customer.family && customer.family.length > 0) {
                    customer.family.forEach((fam, idx) => {
                        const opt = document.createElement('option');
                        opt.value = idx;
                        const ageStr = calculateAge(fam.dob);
                        opt.textContent = fam.name + ' ' + ageStr;
                        famSelect.appendChild(opt);
                    });
                }
                // Auto Select first child or reset
                if (customer.family && customer.family.length > 0) {
                    famSelect.value = "0";
                } else {
                    famSelect.value = "";
                }
                onFamilySelect(); // Updates UI based on selection

                // Reset form
                document.getElementById('startHour').value = "09";
                document.getElementById('startMinute').value = "00";
                autoSetEndTime();

                document.getElementById('reportInput').value = '';

                // Clear all results
                document.getElementById('internalResult').value = '';
                document.getElementById('customerResult').value = '';
                document.getElementById('accOccurrenceTime').value = '';
                document.getElementById('accLocation').value = '';
                document.getElementById('accContent').value = '';
                document.getElementById('accSituation').value = '';
                document.getElementById('accResponse').value = '';
                document.getElementById('accParentCorrespondence').value = '';
                document.getElementById('accDiagnosis').value = '';
                document.getElementById('accPrevention').value = '';

                document.getElementById('warningsArea').classList.add('hidden');

                // Default to Daily
                switchMode('daily');
                resetRatings();
                resetDate();

                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modalContent.classList.remove('translate-y-full');
                }, 10);
            }


            function onFamilySelect() {
                const idx = document.getElementById('familySelector').value;
                const infoBox = document.getElementById('familyInfoBox');

                // Always hide info box as requested ("No annotations", "Only list")
                infoBox.classList.add('hidden');

                if (idx === "") {
                    document.getElementById('accTargetName').value = '';
                    document.getElementById('accTargetDob').value = '';
                    return;
                }

                const fam = currentCustomer.family[idx];
                if (fam) {
                    // Auto-fill Accident fields
                    document.getElementById('accTargetName').value = fam.name;
                    document.getElementById('accTargetDob').value = fam.dob;
                }
            }

            function closeModal() {
                modal.classList.add('opacity-0');
                modalContent.classList.add('translate-y-full');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    currentCustomer = null;
                }, 300);
            }

            function autoSetEndTime() {
                const sH = parseInt(document.getElementById('startHour').value);
                const sM = document.getElementById('startMinute').value;
                if (isNaN(sH)) return;
                let eH = sH + 2;
                if (eH >= 24) eH -= 24;
                const pad = (n) => n.toString().padStart(2, '0');
                document.getElementById('endHour').value = pad(eH);
                document.getElementById('endMinute').value = sM;
            }

            function generateReport() {
                const input = document.getElementById('reportInput').value;
                const start = `${document.getElementById('startHour').value}:${document.getElementById('startMinute').value}`;

                if (!input.trim()) {
                    showToast('„É°„É¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                const btn = document.getElementById('generateBtn');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full loading-spinner"></div> ÁîüÊàê‰∏≠...';

                if (currentReportMode === 'daily') {
                    const end = `${document.getElementById('endHour').value}:${document.getElementById('endMinute').value}`;
                    google.script.run.withSuccessHandler(onReportGenerated).withFailureHandler(e => {
                        showToast('Error: ' + e.message, true);
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }).generateReportWithWarnings({
                        text: input,
                        start: start,
                        end: end
                    });
                } else {
                    // Accident Mode
                    google.script.run.withSuccessHandler(onAccidentReportGenerated).withFailureHandler(e => {
                        showToast('Error: ' + e.message, true);
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }).generateAccidentReport({
                        text: input,
                        start: start,
                        end: "" // not used potentially
                    });
                }
            }

            function onReportGenerated(result) {
                const btn = document.getElementById('generateBtn');
                btn.disabled = false;
                btn.innerHTML = '<span>Êó•Â†±„Çí‰ΩúÊàê„Åô„Çã</span>';

                const warningsArea = document.getElementById('warningsArea');
                if (result.warnings && result.warnings.length > 0) {
                    document.getElementById('warningsList').textContent = result.warnings.join(', ');
                    warningsArea.classList.remove('hidden');
                    warningsArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    warningsArea.classList.add('hidden');
                    document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }

                let customerText = result.customer;
                if (currentStaffName) {
                    const parts = currentStaffName.split(/[\s„ÄÄ]+/);
                    if (parts.length > 0) {
                        customerText += '\n\n' + parts[0];
                    }
                }

                document.getElementById('internalResult').value = result.internal;
                document.getElementById('customerResult').value = customerText;
                document.getElementById('resultArea').classList.remove('hidden');
                document.getElementById('saveBtnContainer').classList.remove('hidden'); // Show shared save button

                updateCharCounts();
            }

            function onAccidentReportGenerated(result) {
                const btn = document.getElementById('generateBtn');
                btn.disabled = false;
                btn.innerHTML = '<span>‰∫ãÊïÖÂ†±ÂëäÊõ∏„Çí‰ΩúÊàê„Åô„Çã</span>';

                if (result.error) {
                    showToast(result.error, true);
                    return;
                }

                // Populate fields
                document.getElementById('accOccurrenceTime').value = result.occurrenceTime || '';
                document.getElementById('accLocation').value = result.location || '';
                document.getElementById('accContent').value = result.accidentContent || '';
                document.getElementById('accSituation').value = result.situation || '';
                document.getElementById('accResponse').value = result.immediateResponse || '';
                document.getElementById('accParentCorrespondence').value = result.parentCorrespondence || '';
                document.getElementById('accDiagnosis').value = result.diagnosisTreatment || '';
                document.getElementById('accPrevention').value = result.prevention || '';

                document.getElementById('accidentResultArea').classList.remove('hidden');
                document.getElementById('accidentResultArea').scrollIntoView({ behavior: 'smooth', block: 'start' });
                document.getElementById('saveBtnContainer').classList.remove('hidden');
            }

            function updateCharCounts() {
                const internalLen = document.getElementById('internalResult').value.length;
                const customerLen = document.getElementById('customerResult').value.length;
                document.getElementById('internalCount').textContent = internalLen + 'ÊñáÂ≠ó';
                document.getElementById('customerCount').textContent = customerLen + 'ÊñáÂ≠ó';
            }

            function saveReport() {
                const btn = document.getElementById('saveBtn');
                if (btn.disabled) return; // Extra safety check

                btn.disabled = true;
                btn.textContent = '‰øùÂ≠ò‰∏≠...';

                // Format Date
                const y = reportTargetDate.getFullYear();
                const m = (reportTargetDate.getMonth() + 1).toString().padStart(2, '0');
                const d = reportTargetDate.getDate().toString().padStart(2, '0');
                const dateStr = `${y}/${m}/${d}`;

                if (currentReportMode === 'daily') {
                    const start = `${document.getElementById('startHour').value}:${document.getElementById('startMinute').value}`;
                    const end = `${document.getElementById('endHour').value}:${document.getElementById('endMinute').value}`;

                    google.script.run.withSuccessHandler((res) => {
                        const msg = (res && res.message) ? res.message : '‰øùÂ≠ò„Åó„Åæ„Åó„Åü';
                        // Determine if it was a "success" in terms of saving data
                        // saveReport returns { success: true/false. message: ... }
                        // If images failed but text saved, success is true.

                        const isError = (res && !res.success);
                        const isWarning = (res && res.message && res.message.includes('Â§±Êïó')); // Image warning

                        showToast(msg, isError || isWarning);

                        if (res && res.success) {
                            // Report text saved successfully (even if image warning). Close modal to prevent duplicate.
                            closeModal();
                            // Button remains disabled while modal fades out
                        } else {
                            // Report failed to save (e.g. validaton error in GAS?)
                            btn.disabled = false;
                            btn.textContent = '‰øùÂ≠ò„Åô„Çã';
                        }
                    }).withFailureHandler(e => {
                        showToast('Error: ' + e.message, true);
                        btn.disabled = false;
                        btn.textContent = '‰øùÂ≠ò„Åô„Çã';
                    }).saveReport({
                        customerId: currentCustomer.id,
                        customerName: currentCustomer.name,
                        inputText: document.getElementById('reportInput').value,
                        start: start,
                        end: end,
                        internalText: document.getElementById('internalResult').value,
                        customerText: document.getElementById('customerResult').value,
                        staffName: currentStaffName,
                        images: currentImages,
                        riskRating: assessmentRatings.risk,
                        esRating: assessmentRatings.es,
                        reportDate: dateStr
                    });
                } else {
                    // Save Accident
                    const reportType = document.querySelector('input[name="accType"]:checked').value;

                    google.script.run.withSuccessHandler(() => {
                        showToast(reportType + '„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                        closeModal();
                    }).withFailureHandler(e => {
                        showToast('Error: ' + e.message, true);
                        btn.disabled = false;
                        btn.textContent = '‰øùÂ≠ò„Åô„Çã';
                    }).saveAccidentReport({
                        customerId: currentCustomer.id,
                        customerName: currentCustomer.name,
                        staffName: currentStaffName,
                        targetName: document.getElementById('accTargetName').value,
                        targetDob: document.getElementById('accTargetDob').value,
                        inputText: document.getElementById('reportInput').value,
                        occurrenceTime: document.getElementById('accOccurrenceTime').value,
                        location: document.getElementById('accLocation').value,
                        accidentContent: document.getElementById('accContent').value,
                        situation: document.getElementById('accSituation').value,
                        immediateResponse: document.getElementById('accResponse').value,
                        parentCorrespondence: document.getElementById('accParentCorrespondence').value,
                        diagnosisTreatment: document.getElementById('accDiagnosis').value,
                        prevention: document.getElementById('accPrevention').value,
                        reportType: reportType,
                        reportDate: dateStr
                    });
                }
            }

            function startVoiceInput() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

                if (!SpeechRecognition) {
                    showToast('„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØWeb Speech API„Å´„Çà„ÇãÈü≥Â£∞ÂÖ•Âäõ„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ', true);
                    return;
                }

                const micBtn = document.getElementById('micBtn');
                if (micBtn.disabled) return; // Prevent double click

                const recognition = new SpeechRecognition();
                recognition.lang = 'ja-JP';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                // UI updating
                micBtn.disabled = true;
                micBtn.classList.add('bg-red-100', 'text-red-700');
                micBtn.innerHTML = '<span class="animate-pulse">üî¥</span> <span>ËÅû„ÅÑ„Å¶„ÅÑ„Åæ„Åô...</span>';

                recognition.start();

                recognition.onresult = function (event) {
                    const transcript = event.results[0][0].transcript;
                    const textarea = document.getElementById('reportInput');
                    textarea.value = (textarea.value ? textarea.value + "\n" : "") + transcript;
                };

                // Using onend to guaranteed cleanup
                recognition.onend = function () {
                    resetMicBtn();
                };

                recognition.onerror = function (event) {
                    console.error(event.error);
                    // Alert specifically for troubleshooting
                    if (event.error === 'not-allowed') {
                        showToast('„Éû„Ç§„ÇØ„ÅÆ‰ΩøÁî®„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„ÅßË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', true);
                    } else if (event.error === 'no-speech') {
                        // Ignore, just silence
                    } else if (event.error === 'network') {
                        showToast('Èü≥Â£∞Ë™çË≠ò„Çµ„Éº„Éê„Éº„Å∏„ÅÆÊé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ', true);
                    } else {
                        showToast('Èü≥Â£∞ÂÖ•Âäõ„Ç®„É©„Éº: ' + event.error, true);
                    }
                    resetMicBtn();
                };
            }

            function resetMicBtn() {
                const micBtn = document.getElementById('micBtn');
                micBtn.disabled = false;
                micBtn.classList.remove('bg-red-100', 'text-red-700');
                micBtn.innerHTML = '<span id="micIcon">üé§</span> <span>Èü≥Â£∞ÂÖ•Âäõ</span>';
            }

            function copyToClipboard(elementId) {
                const el = document.getElementById(elementId);
                el.select();
                document.execCommand('copy');
                showToast('„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
            }

            function showToast(message, isError = false) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.remove('bg-gray-800', 'bg-red-600', 'opacity-0', 'translate-y-4');

                if (isError) {
                    toast.classList.add('bg-red-600');
                } else {
                    toast.classList.add('bg-gray-800');
                }

                // Show
                toast.classList.remove('opacity-0');

                // Hide after 3s
                setTimeout(() => {
                    toast.classList.add('opacity-0');
                }, 3000);
            }
            // Image Handling
            let currentImages = []; // Array of { data: base64, amount: number|string, loading: boolean }

            function triggerCamera() {
                document.getElementById('cameraInput').click();
            }

            function triggerGallery() {
                document.getElementById('galleryInput').click();
            }

            function handleFileSelect(input) {
                const files = Array.from(input.files);
                if (files.length === 0) return;

                // Check limit
                if (currentImages.length + files.length > 6) {
                    showToast('ÁîªÂÉè„ÅØÊúÄÂ§ß6Êûö„Åæ„Åß„Åß„Åô', true);
                    input.value = '';
                    return;
                }

                let processedCount = 0;
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        resizeAndAddImage(e.target.result, () => {
                            processedCount++;
                            if (processedCount === files.length) {
                                input.value = ''; // Reset
                            }
                        });
                    };
                    reader.readAsDataURL(file);
                });
            }

            function resizeAndAddImage(base64Str, callback) {
                const img = new Image();
                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 1200;
                    const MAX_HEIGHT = 1200;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Compress to JPEG 0.7
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);

                    // Add to list with empty amount and loading state
                    const newIdx = currentImages.length;
                    currentImages.push({ data: dataUrl, amount: '', loading: true });
                    renderImagePreviews();

                    // Trigger OCR
                    runOcr(newIdx, dataUrl);

                    if (callback) callback();
                };
                img.src = base64Str;
            }

            function runOcr(index, base64Data) {
                google.script.run.withSuccessHandler(res => {
                    if (currentImages[index]) {
                        currentImages[index].loading = false;
                        if (res.amount) {
                            currentImages[index].amount = res.amount;
                        }
                        renderImagePreviews();
                    }
                }).withFailureHandler(e => {
                    console.error("OCR Failed", e);
                    if (currentImages[index]) {
                        currentImages[index].loading = false;
                        renderImagePreviews();
                    }
                }).extractAmountFromImage(base64Data);
            }

            function renderImagePreviews() {
                const container = document.getElementById('imagePreviewContainer');
                container.innerHTML = '';

                currentImages.forEach((imgObj, idx) => {
                    const div = document.createElement('div');
                    div.className = 'relative w-28 flex flex-col gap-1 items-center'; // increased width

                    // Image Container
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'relative w-24 h-24 rounded-xl overflow-hidden shadow-sm border border-gray-200 group bg-gray-100';

                    imgDiv.innerHTML = `
                    <img src="${imgObj.data}" class="w-full h-full object-cover">
                    <button onclick="removeImage(${idx})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-80 hover:opacity-100 shadow-md z-10">
                        &times;
                    </button>
                    ${imgObj.loading ? '<div class="absolute inset-0 bg-black/30 flex items-center justify-center"><div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full loading-spinner"></div></div>' : ''}
                `;

                    // Wrapper for input with "ÂÜÜ" label
                    const inputContainer = document.createElement('div');
                    inputContainer.className = "w-full px-1";
                    // Using oninput to update model
                    inputContainer.innerHTML = `
                    <input type="number" 
                        value="${imgObj.amount}" 
                        placeholder="ÈáëÈ°ç" 
                        step="100"
                        oninput="currentImages[${idx}].amount = this.value"
                        class="w-full p-1 text-sm border border-gray-300 rounded text-center focus:ring-1 focus:ring-blue-500"
                    >
                `;

                    div.appendChild(imgDiv);
                    div.appendChild(inputContainer);
                    container.appendChild(div);
                });

                // Toggle Add Button Visibility
                const camBtn = document.getElementById('addCameraBtn');
                const galBtn = document.getElementById('addGalleryBtn');

                if (currentImages.length >= 6) {
                    if (camBtn) camBtn.classList.add('hidden');
                    if (galBtn) galBtn.classList.add('hidden');
                } else {
                    if (camBtn) camBtn.classList.remove('hidden');
                    if (galBtn) galBtn.classList.remove('hidden');
                }
            }

            function removeImage(index) {
                currentImages.splice(index, 1);
                // Re-render will fix indices in handlers because it loops generic idx
                renderImagePreviews();
            }

            // Also reset images when opening modal
            const originalOpenModal = openModal;
            openModal = function (customer) {
                originalOpenModal(customer);
                currentImages = []; // Reset
                renderImagePreviews();
            };

        </script>
        <!-- Customer Detail Modal -->
        <div id="customerDetailModal"
            class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4 transition-opacity opacity-0">
            <div
                class="bg-white w-full max-w-2xl max-h-[90vh] rounded-2xl shadow-2xl flex flex-col transform transition-transform scale-95">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
                    <h3 class="font-bold text-lg text-gray-800">È°ßÂÆ¢Ë©≥Á¥∞ÊÉÖÂ†±</h3>
                    <button onclick="closeCustomerDetail()"
                        class="p-2 hover:bg-gray-200 rounded-full text-gray-500">&times;</button>
                </div>
                <div class="p-6 overflow-y-auto space-y-6">
                    <!-- Family Section -->
                    <div>
                        <h4 class="font-bold text-gray-700 mb-2 border-l-4 border-blue-500 pl-2">„ÅîÂÆ∂ÊóèÊÉÖÂ†±</h4>
                        <div id="detailFamilyList" class="space-y-2"></div>
                    </div>
                    <!-- Customer Data Section -->
                    <div>
                        <h4 class="font-bold text-gray-700 mb-2 border-l-4 border-green-500 pl-2">Âü∫Êú¨ÊÉÖÂ†±</h4>
                        <div id="detailCustomerTable" class="grid grid-cols-1 gap-y-2 text-sm"></div>
                    </div>

                    <!-- Past Reports Section Removed -->
                </div>
                <div class="p-4 border-t bg-gray-50 rounded-b-2xl text-right">
                    <button onclick="closeCustomerDetail()"
                        class="px-4 py-2 bg-gray-600 text-white text-sm rounded-lg hover:bg-gray-700">Èñâ„Åò„Çã</button>
                </div>
            </div>
        </div>

        <!-- Customer History Modal -->
        <div id="customerHistoryModal"
            class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4 transition-opacity opacity-0">
            <div
                class="bg-white w-full max-w-2xl max-h-[90vh] rounded-2xl shadow-2xl flex flex-col transform transition-transform scale-95">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
                    <h3 class="font-bold text-lg text-gray-800">ÈÅéÂéª„ÅÆÊ¥ªÂãïË®òÈå≤</h3>
                    <button onclick="closeCustomerHistory()"
                        class="p-2 hover:bg-gray-200 rounded-full text-gray-500">&times;</button>
                </div>
                <div class="p-6 overflow-y-auto space-y-6">
                    <div id="historySection">
                        <h4
                            class="font-bold text-gray-700 mb-2 border-l-4 border-orange-500 pl-2 flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <span>„Çø„Ç§„É†„É©„Ç§„É≥</span>
                                <button onclick="if(currentDetailId) loadCustomerHistory(currentDetailId, true)"
                                    class="p-1 hover:bg-orange-100 rounded text-orange-400 hover:text-orange-600 transition-colors"
                                    title="Êõ¥Êñ∞">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                        </path>
                                    </svg>
                                </button>
                            </div>
                            <span id="historyLoading"
                                class="hidden text-xs font-normal text-gray-500 flex items-center gap-1">
                                <div
                                    class="w-3 h-3 border-2 border-gray-400 border-t-transparent rounded-full animate-spin">
                                </div>
                                Ë™≠„ÅøËæº„Åø‰∏≠...
                            </span>
                        </h4>
                        <div id="detailReportTimeline" class="space-y-4 pl-2 border-l-2 border-gray-200 ml-2 relative">
                            <!-- Timeline items will go here -->
                            <div class="text-xs text-gray-400 py-4 pl-4">Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...</div>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t bg-gray-50 rounded-b-2xl text-right">
                    <button onclick="closeCustomerHistory()"
                        class="px-4 py-2 bg-gray-600 text-white text-sm rounded-lg hover:bg-gray-700">Èñâ„Åò„Çã</button>
                </div>
            </div>
        </div>

</body>

</html>
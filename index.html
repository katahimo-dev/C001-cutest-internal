<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿è‚²æ—¥å ±ã‚¢ãƒ—ãƒª</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f3f4f6;
        }

        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .loading-spinner {
            border-top-color: #3b82f6;
            border-left-color: #3b82f6;
            animation: spin 1s infinite linear;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen text-gray-800">

    <div id="app" class="max-w-md mx-auto min-h-screen flex flex-col relative bg-white shadow-xl overflow-hidden">
        <!-- Login Modal -->
        <div id="loginModal" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm space-y-6">
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-gray-800">ãƒ­ã‚°ã‚¤ãƒ³</h2>
                    <p class="text-sm text-gray-500 mt-1">ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
                        <input type="text" id="loginEmail"
                            class="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500"
                            placeholder="ex: nakahara">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="loginPass"
                            class="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500"
                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>
                </div>
                <div id="loginError" class="text-red-500 text-sm text-center min-h-[1.25rem]"></div>
                <button onclick="doLogin()" id="loginBtn"
                    class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transform transition-transform active:scale-95">
                    ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </div>
        </div>
        <!-- Header -->
        <!-- Header -->
        <header class="bg-blue-600 text-white p-4 shadow-md z-10 sticky top-0 flex items-center justify-between">
            <h1 class="text-xl font-bold tracking-wider">ä¿è‚²æ—¥å ±</h1>
            <div class="flex items-center gap-3">
                <button onclick="openSettings()" id="settingsBtn"
                    class="hidden p-2 bg-white/20 hover:bg-white/30 rounded-full transition-colors" title="è¨­å®š">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
                <span id="headerUserName" class="text-sm font-medium opacity-90"></span>
                <button onclick="doLogout()" class="p-2 bg-white/20 hover:bg-white/30 rounded-full transition-colors"
                    title="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                        </path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow p-4 overflow-y-auto pb-24">

            <!-- Filters -->
            <div class="mb-6 space-y-3">
                <div class="flex gap-2">
                    <div class="relative flex-grow">
                        <input type="text" id="searchInput" placeholder="é¡§å®¢åã§æ¤œç´¢..."
                            class="w-full pl-10 pr-4 py-3 rounded-xl border-none ring-1 ring-gray-200 focus:ring-2 focus:ring-blue-500 bg-gray-50 text-base shadow-sm transition-all"
                            oninput="filterCustomers()">
                        <svg class="w-5 h-5 absolute left-3 top-3.5 text-gray-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <!-- Refresh Button -->
                    <button onclick="reloadData(true)" id="refreshBtn"
                        class="px-3 bg-white text-blue-600 rounded-xl border border-blue-100 hover:bg-blue-50 transition-colors shadow-sm flex-shrink-0 flex items-center justify-center"
                        title="é¡§å®¢æƒ…å ±ã®æ›´æ–°">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                            </path>
                        </svg>
                    </button>
                </div>

                <div class="relative">
                    <select id="cityFilter" onchange="filterCustomers()"
                        class="w-full appearance-none pl-4 pr-10 py-3 rounded-xl border-none ring-1 ring-gray-200 focus:ring-2 focus:ring-blue-500 bg-gray-50 text-base shadow-sm transition-all">
                        <option value="">å…¨ã¦ã®åœ°åŸŸ</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                            <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Customer List -->
            <div id="customerList" class="space-y-3">
                <!-- Loading State -->
                <div class="flex justify-center py-8">
                    <div class="w-8 h-8 rounded-full border-4 border-gray-200 loading-spinner"></div>
                </div>
            </div>

        </main>

        <!-- Report Modal (Overlay) -->
        <div id="reportModal"
            class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end sm:items-center justify-center transition-opacity opacity-0">
            <div
                class="bg-white w-full max-w-md h-[90vh] sm:h-auto sm:max-h-[85vh] sm:rounded-2xl rounded-t-2xl shadow-2xl flex flex-col transform transition-transform translate-y-full">

                <!-- Modal Header -->
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
                    <div>
                        <h2 class="font-bold text-lg text-gray-800" id="modalCustomerName">Customer Name</h2>
                        <p class="text-xs text-gray-500" id="modalCustomerAddress">Address</p>
                    </div>
                    <button onclick="closeModal()"
                        class="p-2 hover:bg-gray-200 rounded-full text-gray-500">&times;</button>
                </div>

                <!-- Tabs -->
                <div class="flex border-b border-gray-200">
                    <button onclick="switchMode('daily')" id="tabDaily"
                        class="flex-1 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600 transition-colors">ä¿è‚²æ—¥å ±</button>
                    <button onclick="switchMode('accident')" id="tabAccident"
                        class="flex-1 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent transition-colors">äº‹æ•…å ±å‘Š</button>
                </div>

                <!-- Family Selector -->
                <div class="px-4 pt-3 pb-1 bg-blue-50">
                    <label class="block text-xs font-bold text-gray-600 mb-1">å¯¾è±¡ã®ãŠå­æ§˜</label>
                    <select id="familySelector" onchange="onFamilySelect()"
                        class="w-full p-2 text-sm border-gray-300 rounded mb-2">
                        <option value="">(é¸æŠã—ã¦ãã ã•ã„)</option>
                    </select>
                    <div id="familyInfoBox" class="hidden mb-2 flex items-stretch gap-2">
                        <div id="allergyContainer" class="hidden flex-1 min-w-0">
                            <p id="familyAllergy"
                                class="h-full flex items-center justify-center text-red-600 font-bold text-base bg-red-50 p-2 rounded-lg border border-red-100 shadow-sm text-center break-words">
                            </p>
                        </div>
                        <p id="familyInfo"
                            class="hidden flex-1 min-w-0 text-xs text-gray-700 bg-yellow-50 p-2 rounded border border-yellow-100 break-words flex items-center">
                        </p>
                    </div>
                </div>

                <!-- Modal Body -->
                <div class="p-4 overflow-y-auto flex-grow space-y-4">
                    <!-- Time (Shared) -->
                    <div class="grid grid-cols-1 gap-4">
                        <!-- Start Time -->
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">é–‹å§‹æ™‚é–“/ç™ºç”Ÿæ™‚é–“</label>
                            <div class="flex items-center gap-2">
                                <select id="startHour" class="flex-1 p-2 rounded-lg border border-gray-300 bg-gray-50"
                                    onchange="autoSetEndTime()">
                                    <!-- Populated by JS -->
                                </select>
                                <span class="text-gray-400">:</span>
                                <select id="startMinute" class="flex-1 p-2 rounded-lg border border-gray-300 bg-gray-50"
                                    onchange="autoSetEndTime()">
                                    <option value="00">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                            </div>
                        </div>

                        <!-- End Time -->
                        <div id="endTimeContainer">
                            <label class="block text-xs font-medium text-gray-500 mb-1">çµ‚äº†æ™‚é–“</label>
                            <div class="flex items-center gap-2">
                                <select id="endHour" class="flex-1 p-2 rounded-lg border border-gray-300 bg-gray-50">
                                    <!-- Populated by JS -->
                                </select>
                                <span class="text-gray-400">:</span>
                                <select id="endMinute" class="flex-1 p-2 rounded-lg border border-gray-300 bg-gray-50">
                                    <option value="00">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Input -->
                    <div>
                        <!-- Incident Type Selector -->
                        <div id="accidentTypeSelector" class="hidden mb-2">
                            <div class="flex gap-4 p-2 bg-gray-50 rounded-lg border border-gray-100">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="accType" value="äº‹æ•…å ±å‘Š" checked
                                        onchange="updateAccidentPlaceholder()"
                                        class="w-4 h-4 text-red-600 focus:ring-red-500 border-gray-300">
                                    <span class="text-sm font-bold text-gray-700">äº‹æ•…å ±å‘Š</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="accType" value="ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆ"
                                        onchange="updateAccidentPlaceholder()"
                                        class="w-4 h-4 text-orange-500 focus:ring-orange-400 border-gray-300">
                                    <span class="text-sm font-bold text-gray-700">ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆ</span>
                                </label>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-xs font-medium text-gray-500">ãƒ¡ãƒ¢ (éŸ³å£°å…¥åŠ›ãªã©ã§å…¥åŠ›)</label>
                            <div class="flex gap-2">
                                <button onclick="toggleHint()" id="hintBtn"
                                    class="hidden text-xs bg-indigo-50 hover:bg-indigo-100 text-indigo-600 px-2 py-1 rounded-md flex items-center gap-1 transition-colors">
                                    ğŸ’¡ æ›¸ãæ–¹ã®ãƒ’ãƒ³ãƒˆ
                                </button>
                                <button onclick="startVoiceInput()" id="micBtn"
                                    class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-2 py-1 rounded-md flex items-center gap-1 transition-colors">
                                    <span id="micIcon">ğŸ¤</span> <span>éŸ³å£°å…¥åŠ›</span>
                                </button>
                            </div>
                        </div>
                        <textarea id="reportInput" rows="6"
                            class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 transition-all resize-none text-base"
                            placeholder="çŠ¶æ³ã‚„å†…å®¹ã‚’è‡ªç”±ã«å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>


                        <!-- Warnings Area -->
                        <div id="warningsArea"
                            class="hidden mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-700">
                            <strong>âš ï¸ æƒ…å ±ä¸è¶³:</strong> <span id="warningsList"></span>
                        </div>

                        <!-- Image Upload Section -->
                        <div id="imageUploadSection" class="mt-4 border-t pt-3">
                            <label class="block text-xs font-medium text-gray-500 mb-2">é ˜åæ›¸ãƒ»æ·»ä»˜ç”»åƒ (æœ€å¤§6æš)</label>
                            <div class="flex flex-wrap gap-2 items-start">
                                <!-- Previews -->
                                <div id="imagePreviewContainer" class="flex flex-wrap gap-2">
                                    <!-- Populated by JS -->
                                </div>

                                <!-- Add Button -->
                                <!-- Add Button (Camera) -->
                                <button onclick="triggerCamera()" id="addCameraBtn"
                                    class="w-20 h-20 border-2 border-dashed border-blue-300 rounded-xl flex flex-col items-center justify-center text-blue-500 hover:bg-blue-50 transition-colors bg-white">
                                    <svg class="w-8 h-8 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z">
                                        </path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    <span class="text-[10px] font-bold">ã‚«ãƒ¡ãƒ©æ’®å½±</span>
                                </button>

                                <!-- Add Button (Gallery) -->
                                <button onclick="triggerGallery()" id="addGalleryBtn"
                                    class="w-20 h-20 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center text-gray-400 hover:text-gray-600 hover:border-gray-400 transition-colors bg-gray-50">
                                    <svg class="w-8 h-8 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                    <span class="text-[10px] font-bold">ã‚¢ãƒ«ãƒãƒ </span>
                                </button>
                            </div>
                            <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden"
                                onchange="handleFileSelect(this)">
                            <input type="file" id="galleryInput" accept="image/*" multiple class="hidden"
                                onchange="handleFileSelect(this)">
                        </div>
                    </div>

                    <!-- Action -->
                    <button onclick="generateReport()" id="generateBtn"
                        class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transform transition-transform active:scale-95 flex items-center justify-center gap-2">
                        <span>æ—¥å ±ã‚’ä½œæˆã™ã‚‹</span>
                    </button>

                    <!-- Daily Report Results -->
                    <div id="resultArea" class="hidden space-y-4 pt-4 border-t">
                        <div class="space-y-1">
                            <h3 class="text-sm font-bold text-gray-700 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-indigo-500"></span>
                                ç¤¾å†…å‘ã‘
                                <span id="internalCount" class="text-xs text-gray-500 font-normal ml-2">0æ–‡å­—</span>
                            </h3>
                            <textarea id="internalResult" rows="10" oninput="updateCharCounts()"
                                class="w-full p-3 bg-white rounded-lg text-sm leading-relaxed text-gray-900 border border-indigo-200 focus:ring-2 focus:ring-indigo-300 shadow-sm"></textarea>
                        </div>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center">
                                <h3 class="text-sm font-bold text-gray-700 flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                    ä¿è­·è€…å‘ã‘
                                    <span id="customerCount" class="text-xs text-gray-500 font-normal ml-2">0æ–‡å­—</span>
                                </h3>
                                <button onclick="copyToClipboard('customerResult')"
                                    class="text-xs bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 rounded flex items-center gap-1">
                                    ğŸ“‹ ã‚³ãƒ”ãƒ¼
                                </button>
                            </div>
                            <textarea id="customerResult" rows="10" oninput="updateCharCounts()"
                                class="w-full p-3 bg-white rounded-lg text-sm leading-relaxed text-gray-900 border border-green-200 focus:ring-2 focus:ring-green-300 shadow-sm"></textarea>
                        </div>
                    </div>

                    <!-- Accident Report Results -->
                    <div id="accidentResultArea" class="hidden space-y-4 pt-4 border-t">
                        <h3 class="text-sm font-bold text-gray-800 border-b pb-2">äº‹æ•…å ±å‘Šæ›¸ãƒ‰ãƒ©ãƒ•ãƒˆ</h3>

                        <div class="space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-gray-500">å¯¾è±¡è€…æ°å</label>
                                    <input type="text" id="accTargetName"
                                        class="w-full p-2 rounded border border-gray-300 text-sm bg-gray-50" readonly>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-500">ç”Ÿå¹´æœˆæ—¥</label>
                                    <input type="text" id="accTargetDob"
                                        class="w-full p-2 rounded border border-gray-300 text-sm bg-gray-50" readonly>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500">ç™ºç”Ÿæ—¥æ™‚</label>
                                <input type="text" id="accOccurrenceTime"
                                    class="w-full p-2 rounded border border-gray-300 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500">ç™ºç”Ÿå ´æ‰€</label>
                                <input type="text" id="accLocation"
                                    class="w-full p-2 rounded border border-gray-300 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500">äº‹æ•…å†…å®¹</label>
                                <input type="text" id="accContent"
                                    class="w-full p-2 rounded border border-gray-300 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500">ç™ºç”ŸçŠ¶æ³</label>
                                <textarea id="accSituation" rows="3"
                                    class="w-full p-2 rounded border border-gray-300 text-sm"></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500">ç™ºç”Ÿæ™‚ã®å¯¾å¿œ</label>
                                <textarea id="accResponse" rows="3"
                                    class="w-full p-2 rounded border border-gray-300 text-sm"></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500">ä¿è­·è€…ã¸ã®å¯¾å¿œ</label>
                                <textarea id="accParentCorrespondence" rows="3"
                                    class="w-full p-2 rounded border border-gray-300 text-sm"></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500">è¨ºæ–­åãŠã‚ˆã³å‡¦ç½®çŠ¶æ³</label>
                                <textarea id="accDiagnosis" rows="2"
                                    class="w-full p-2 rounded border border-gray-300 text-sm"></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500">ä»Šå¾Œã®å¯¾å¿œ</label>
                                <textarea id="accPrevention" rows="3"
                                    class="w-full p-2 rounded border border-gray-300 text-sm"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Shared Save Button -->
                    <div id="saveBtnContainer" class="hidden">
                        <button onclick="saveReport()" id="saveBtn"
                            class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg transform transition-transform active:scale-95">
                            ä¿å­˜ã™ã‚‹
                        </button>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <!-- Toast Notification -->
    <div id="toast"
        class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg transition-opacity duration-300 opacity-0 pointer-events-none z-50 text-sm font-medium">
        Notification Message
    </div>

    <!-- Script -->
    <!-- Hint Modal -->
    <div id="hintModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center transition-opacity opacity-0">
        <div
            class="bg-white w-full max-w-lg mx-4 rounded-xl shadow-2xl flex flex-col max-h-[80vh] transform transition-transform scale-95">
            <div class="p-4 border-b flex justify-between items-center bg-indigo-50 rounded-t-xl">
                <h3 class="font-bold text-gray-800">äº‹æ•…å ±å‘Šæ›¸ã®æ›¸ãæ–¹ãƒ’ãƒ³ãƒˆ</h3>
                <button onclick="toggleHint()"
                    class="p-2 hover:bg-indigo-100 rounded-full text-indigo-500">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto whitespace-pre-wrap text-sm leading-relaxed text-gray-700" id="hintContent">
                <!-- Content loaded from JS -->
            </div>
            <div class="p-4 border-t bg-gray-50 rounded-b-xl text-right">
                <button onclick="toggleHint()"
                    class="px-4 py-2 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal"
        class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm space-y-4">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-2">è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>

            <div class="space-y-3">
                <label class="block text-sm font-medium text-gray-700">é¡§å®¢ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬æ›´æ–° (CSV)</label>



                <input type="file" id="csvFile" accept=".csv"
                    class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <p class="text-xs text-gray-400">â€»UTF-8ã®ã¿å¯¾å¿œã€‚é¡§å®¢IDã‚’ã‚­ãƒ¼ã«æ›´æ–°ã—ã¾ã™ã€‚</p>
            </div>

            <div class="pt-4 flex gap-3">
                <button onclick="closeSettings()"
                    class="flex-1 py-2 text-gray-600 font-medium hover:bg-gray-100 rounded-lg transition-colors">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="handleFileUpload()" id="uploadBtn"
                    class="flex-1 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
            </div>
        </div>
    </div>

    <script>
        let allCustomers = [];
        let currentCustomer = null;
        let currentStaffName = '';
        let currentReportMode = 'daily'; // 'daily' or 'accident'
        let uiConfig = {};

        let localDataVersion = '0';

        const CACHE_KEY = 'GAS_CUSTOMER_DATA_V2';
        const STAFF_CACHE_KEY = 'GAS_STAFF_SESSION_V3';
        const STAFF_ADMIN_KEY = 'GAS_STAFF_ADMIN';
        const ENC_KEY = 123; // Simple key

        // Initialize
        window.onload = function () {
            populateHours();
            checkLogin();
            loadUiConfig();
            startVersionPolling();
        };

        function startVersionPolling() {
            checkForUpdates(); // Check immediately on load
            setInterval(checkForUpdates, 60000); // Check every minute
        }

        function checkForUpdates() {
            // Check current version from server

            google.script.run.withSuccessHandler(serverVersion => {
                if (serverVersion && serverVersion !== localDataVersion) {
                    console.log("New data detected:", serverVersion);
                    showToast("æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚æ›´æ–°ã—ã¦ã„ã¾ã™...", false);
                    reloadData(true);
                }
            }).checkDataVersion();
        }

        // ... loadUiConfig ...
        // ... switchMode ...

        function checkLogin() {
            const savedName = localStorage.getItem(STAFF_CACHE_KEY);
            if (savedName) {
                currentStaffName = savedName;
                document.getElementById('headerUserName').textContent = savedName + ' ã•ã‚“';
                document.getElementById('loginModal').classList.add('hidden');

                // Admin check
                if (localStorage.getItem(STAFF_ADMIN_KEY) === 'true') {
                    document.getElementById('settingsBtn').classList.remove('hidden');
                } else {
                    document.getElementById('settingsBtn').classList.add('hidden');
                }

                loadData(false);
            } else {
                document.getElementById('loginModal').classList.remove('hidden');
            }
        }

        function loadUiConfig() {
            google.script.run.withSuccessHandler(config => {
                uiConfig = config;
                // Apply default placeholder based on current mode defaults or just wait for switch
                if (currentReportMode === 'daily' && uiConfig.dailyPlaceholder) {
                    document.getElementById('reportInput').placeholder = uiConfig.dailyPlaceholder;
                }
            }).getUiConfig();
        }

        function switchMode(mode) {
            currentReportMode = mode;
            const tabDaily = document.getElementById('tabDaily');
            const tabAccident = document.getElementById('tabAccident');
            const hintBtn = document.getElementById('hintBtn');
            const input = document.getElementById('reportInput');
            const typeSelector = document.getElementById('accidentTypeSelector');
            const imageSection = document.getElementById('imageUploadSection');

            // UI Toggle
            if (mode === 'daily') {
                tabDaily.className = "flex-1 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600 transition-colors";
                tabAccident.className = "flex-1 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent transition-colors";

                document.getElementById('endTimeContainer').classList.remove('hidden');
                document.getElementById('generateBtn').querySelector('span').textContent = 'æ—¥å ±ã‚’ä½œæˆã™ã‚‹';

                hintBtn.classList.add('hidden');
                typeSelector.classList.add('hidden');

                if (imageSection) imageSection.classList.remove('hidden');

                input.placeholder = uiConfig.dailyPlaceholder || "çŠ¶æ³ã‚„å†…å®¹ã‚’è‡ªç”±ã«å…¥åŠ›ã—ã¦ãã ã•ã„...";

                // Show/Hide results based on previous state
                const hasDailyResult = document.getElementById('internalResult').value !== '';
                if (hasDailyResult) {
                    document.getElementById('resultArea').classList.remove('hidden');
                    document.getElementById('saveBtnContainer').classList.remove('hidden');
                } else {
                    document.getElementById('resultArea').classList.add('hidden');
                    document.getElementById('saveBtnContainer').classList.add('hidden');
                }
                document.getElementById('accidentResultArea').classList.add('hidden');

            } else {
                tabDaily.className = "flex-1 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent transition-colors";
                tabAccident.className = "flex-1 py-3 text-sm font-medium text-red-600 border-b-2 border-red-600 transition-colors";

                document.getElementById('endTimeContainer').classList.add('hidden');
                document.getElementById('generateBtn').querySelector('span').textContent = 'äº‹æ•…å ±å‘Šæ›¸ã‚’ä½œæˆã™ã‚‹';

                hintBtn.classList.remove('hidden');
                typeSelector.classList.remove('hidden');

                if (imageSection) imageSection.classList.add('hidden');

                // Update Placeholder based on selection
                updateAccidentPlaceholder();

                document.getElementById('resultArea').classList.add('hidden');

                const hasAccidentResult = document.getElementById('accOccurrenceTime').value !== '';
                if (hasAccidentResult) {
                    document.getElementById('accidentResultArea').classList.remove('hidden');
                    document.getElementById('saveBtnContainer').classList.remove('hidden');
                } else {
                    document.getElementById('accidentResultArea').classList.add('hidden');
                    document.getElementById('saveBtnContainer').classList.add('hidden');
                }
            }
        }

        function updateAccidentPlaceholder() {
            if (currentReportMode !== 'accident') return;
            const type = document.querySelector('input[name="accType"]:checked').value;
            const input = document.getElementById('reportInput');

            if (type === 'ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆ') {
                input.placeholder = uiConfig.hiyariPlaceholder || "ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆã®çŠ¶æ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...";
            } else {
                input.placeholder = uiConfig.accidentPlaceholder || "äº‹æ•…ã®çŠ¶æ³ã‚’è©³ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„...";
            }
        }

        function toggleHint() {
            const modal = document.getElementById('hintModal');
            if (modal.classList.contains('hidden')) {
                document.getElementById('hintContent').textContent = uiConfig.accidentHint || "Loading...";
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);
            } else {
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        function doLogin() {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            const btn = document.getElementById('loginBtn');
            const err = document.getElementById('loginError');

            if (!email || !pass) {
                err.textContent = "å…¥åŠ›ã—ã¦ãã ã•ã„";
                return;
            }

            btn.disabled = true;
            btn.textContent = "ç¢ºèªä¸­...";
            err.textContent = "";

            google.script.run.withSuccessHandler(res => {
                btn.disabled = false;
                btn.textContent = "ãƒ­ã‚°ã‚¤ãƒ³";
                if (res.success) {
                    currentStaffName = res.name;
                    localStorage.setItem(STAFF_CACHE_KEY, res.name);

                    // Admin Handling
                    if (res.isAdmin) {
                        localStorage.setItem(STAFF_ADMIN_KEY, 'true');
                        document.getElementById('settingsBtn').classList.remove('hidden');
                    } else {
                        localStorage.removeItem(STAFF_ADMIN_KEY);
                        document.getElementById('settingsBtn').classList.add('hidden');
                    }

                    document.getElementById('headerUserName').textContent = res.name + ' ã•ã‚“';
                    document.getElementById('loginModal').classList.add('hidden');
                    loadData(false);
                } else {
                    err.textContent = res.message;
                }
            }).withFailureHandler(e => {
                btn.disabled = false;
                btn.textContent = "ãƒ­ã‚°ã‚¤ãƒ³";
                err.textContent = "Error: " + e.message;
            }).verifyLogin(email, pass);
        }

        function doLogout() {
            localStorage.removeItem(STAFF_CACHE_KEY);
            localStorage.removeItem(STAFF_ADMIN_KEY);
            location.reload();
        }

        // Settings Modal Logic
        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function handleFileUpload() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            if (!file) {
                alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
                return;
            }

            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;
            btn.textContent = "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...";

            const reader = new FileReader();
            reader.onload = function (e) {
                const content = e.target.result;
                google.script.run.withSuccessHandler(res => {
                    alert(res);
                    btn.disabled = false;
                    btn.textContent = "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰";
                    closeSettings();
                    // Optionally refresh data if the app is now using the new DB
                    // reloadData(true);
                }).withFailureHandler(err => {
                    alert("Error: " + err.message);
                    btn.disabled = false;
                    btn.textContent = "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰";
                }).uploadCustomerCsv(content);
            };
            reader.readAsText(file, 'UTF-8');
        }

        function populateHours() {
            const hours = [];
            for (let i = 0; i < 24; i++) {
                const val = i.toString().padStart(2, '0');
                hours.push(`<option value="${val}">${val}</option>`);
            }
            document.getElementById('startHour').innerHTML = hours.join('');
            document.getElementById('endHour').innerHTML = hours.join('');
            // Set default
            document.getElementById('startHour').value = "09";
            document.getElementById('endHour').value = "11";
        }

        // ... encryption ...
        function encrypt(text) {
            try {
                const chars = text.split('').map(c => String.fromCharCode(c.charCodeAt(0) ^ ENC_KEY));
                return btoa(unescape(encodeURIComponent(chars.join(''))));
            } catch (e) { console.error(e); return null; }
        }
        function decrypt(encoded) {
            try {
                const chars = decodeURIComponent(escape(atob(encoded))).split('');
                return chars.map(c => String.fromCharCode(c.charCodeAt(0) ^ ENC_KEY)).join('');
            } catch (e) { console.error(e); return null; }
        }

        // ... data loading ...
        function reloadData(force) { loadData(force); }
        function loadData(force = false) {
            const container = document.getElementById('customerList');
            // Only show spinner if we don't have data or forcing
            if (force || allCustomers.length === 0) {
                container.innerHTML = '<div class="flex justify-center py-8"><div class="w-8 h-8 rounded-full border-4 border-gray-200 loading-spinner"></div></div>';
            }

            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) refreshBtn.classList.add('animate-spin');

            if (!force) {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    const decrypted = decrypt(cached);
                    if (decrypted) {
                        try {
                            const data = JSON.parse(decrypted);
                            onDataLoaded(data, true);
                            if (refreshBtn) refreshBtn.classList.remove('animate-spin');
                            return;
                        } catch (e) { console.error("Cache parse error", e); }
                    }
                }
            }

            google.script.run.withSuccessHandler((data) => {
                try {
                    const json = JSON.stringify(data);
                    const encrypted = encrypt(json);
                    if (encrypted) localStorage.setItem(CACHE_KEY, encrypted);

                    onDataLoaded(data, false);
                    if (force) showToast('ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                } catch (e) {
                    console.error("Success Handler Error:", e);
                    showToast("ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼: " + e.message, true);
                } finally {
                    if (refreshBtn) refreshBtn.classList.remove('animate-spin');
                }
            }).withFailureHandler((e) => {
                onError(e);
                if (refreshBtn) refreshBtn.classList.remove('animate-spin');
            }).getData();
        }

        function onDataLoaded(data, fromCache) {
            allCustomers = data.customers;
            if (data.version) {
                localDataVersion = data.version;
            }
            const select = document.getElementById('cityFilter');
            select.innerHTML = '<option value="">å…¨ã¦ã®åœ°åŸŸ</option>';
            populateCityFilter(data.cities);
            renderCustomers(allCustomers);
        }
        function onError(e) { showToast('Error: ' + e.message, true); }
        function populateCityFilter(cities) {
            const select = document.getElementById('cityFilter');
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                select.appendChild(option);
            });
        }
        function renderCustomers(customers) {
            const container = document.getElementById('customerList');
            container.innerHTML = '';

            if (customers.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">è©²å½“ã™ã‚‹é¡§å®¢ãŒã„ã¾ã›ã‚“</div>';
                return;
            }

            customers.forEach(c => {
                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer hover:shadow-md transition-shadow active:bg-gray-50';
                el.onclick = () => openModal(c);
                el.innerHTML = `
                    <div>
                        <h3 class="font-bold text-gray-800 text-lg">${c.name}</h3>
                        <p class="text-sm text-gray-500 flex items-center gap-1">
                            <span class="inline-block px-2 py-0.5 bg-gray-100 rounded text-xs">${c.city}</span>
                        </p>
                    </div>
                    <div class="text-blue-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                `;
                container.appendChild(el);
            });
        }
        function filterCustomers() {
            const city = document.getElementById('cityFilter').value;
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allCustomers.filter(c => {
                const matchesCity = city ? c.city === city : true;
                const matchesSearch = c.name.toLowerCase().includes(search);
                return matchesCity && matchesSearch;
            });
            renderCustomers(filtered);
        }

        // Modal Logic
        const modal = document.getElementById('reportModal');
        const modalContent = modal.querySelector('div');

        function calculateAge(dobStr) {
            // "yyyy/MM/dd"
            if (!dobStr) return "";
            const parts = dobStr.split('/');
            if (parts.length !== 3) return "";

            const birthDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            const today = new Date();

            let years = today.getFullYear() - birthDate.getFullYear();
            let months = today.getMonth() - birthDate.getMonth();

            if (today.getDate() < birthDate.getDate()) {
                months--;
            }
            if (months < 0) {
                years--;
                months += 12;
            }

            // To half-width digits
            const toFullWidth = (n) => String(n).replace(/[0-9]/g, s => String.fromCharCode(s.charCodeAt(0) + 0xFEE0));
            // User example shows Full Width numbers: "ï¼æ­³ï¼“ã‹æœˆ"
            // Wait, standard JP usage often uses half-width but user requested "ï¼æ­³ï¼“ã‹æœˆ".
            // I will use full-width for numbers to match request.
            return `ï¼ˆ${toFullWidth(years)}æ­³${toFullWidth(months)}ã‹æœˆï¼‰`;
        }

        function openModal(customer) {
            currentCustomer = customer;
            document.getElementById('modalCustomerName').textContent = customer.name;
            document.getElementById('modalCustomerAddress').textContent = customer.address;

            // Populate Family Selector
            const famSelect = document.getElementById('familySelector');
            famSelect.innerHTML = '<option value="">(é¸æŠã—ã¦ãã ã•ã„)</option>';
            if (customer.family && customer.family.length > 0) {
                customer.family.forEach((fam, idx) => {
                    const opt = document.createElement('option');
                    opt.value = idx;
                    const ageStr = calculateAge(fam.dob);
                    opt.textContent = fam.name + ' ' + ageStr;
                    famSelect.appendChild(opt);
                });
            }
            // Auto Select first child or reset
            if (customer.family && customer.family.length > 0) {
                famSelect.value = "0";
            } else {
                famSelect.value = "";
            }
            onFamilySelect(); // Updates UI based on selection

            // Reset form
            document.getElementById('startHour').value = "09";
            document.getElementById('startMinute').value = "00";
            autoSetEndTime();

            document.getElementById('reportInput').value = '';

            // Clear all results
            document.getElementById('internalResult').value = '';
            document.getElementById('customerResult').value = '';
            document.getElementById('accOccurrenceTime').value = '';
            document.getElementById('accLocation').value = '';
            document.getElementById('accContent').value = '';
            document.getElementById('accSituation').value = '';
            document.getElementById('accResponse').value = '';
            document.getElementById('accParentCorrespondence').value = '';
            document.getElementById('accDiagnosis').value = '';
            document.getElementById('accPrevention').value = '';

            document.getElementById('warningsArea').classList.add('hidden');

            // Default to Daily
            switchMode('daily');

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('translate-y-full');
            }, 10);
        }


        function onFamilySelect() {
            const idx = document.getElementById('familySelector').value;
            const infoBox = document.getElementById('familyInfoBox');
            const allergyContainer = document.getElementById('allergyContainer');
            const familyInfo = document.getElementById('familyInfo');

            if (idx === "") {
                infoBox.classList.add('hidden');
                document.getElementById('accTargetName').value = '';
                document.getElementById('accTargetDob').value = '';
                return;
            }

            const fam = currentCustomer.family[idx];
            if (fam) {
                // Allergy
                if (fam.allergy && fam.allergy.trim() !== "" && fam.allergy !== "ãªã—") {
                    document.getElementById('familyAllergy').textContent = fam.allergy;
                    allergyContainer.classList.remove('hidden');
                } else {
                    allergyContainer.classList.add('hidden');
                }

                // Info
                if (fam.info && fam.info.trim() !== "" && fam.info !== "ãªã—") {
                    familyInfo.textContent = fam.info;
                    familyInfo.classList.remove('hidden');
                } else {
                    familyInfo.classList.add('hidden');
                }

                // If either is visible, show box (actually box acts as container, so always show if fam selected? or only if content?)
                // User said: "infoãŒç©ºç™½ã®å ´åˆã«ã¯ã€è¡¨ç¤ºã—ãªã„" (If info is blank, do not display [it]).
                // If both blank, maybe hide box?
                const hasAllergy = !allergyContainer.classList.contains('hidden');
                const hasInfo = !familyInfo.classList.contains('hidden');

                if (hasAllergy || hasInfo) {
                    infoBox.classList.remove('hidden');
                } else {
                    infoBox.classList.add('hidden');
                }

                // Auto-fill Accident fields
                document.getElementById('accTargetName').value = fam.name;
                document.getElementById('accTargetDob').value = fam.dob;
            }
        }

        function closeModal() {
            modal.classList.add('opacity-0');
            modalContent.classList.add('translate-y-full');
            setTimeout(() => {
                modal.classList.add('hidden');
                currentCustomer = null;
            }, 300);
        }

        function autoSetEndTime() {
            const sH = parseInt(document.getElementById('startHour').value);
            const sM = document.getElementById('startMinute').value;
            if (isNaN(sH)) return;
            let eH = sH + 2;
            if (eH >= 24) eH -= 24;
            const pad = (n) => n.toString().padStart(2, '0');
            document.getElementById('endHour').value = pad(eH);
            document.getElementById('endMinute').value = sM;
        }

        function generateReport() {
            const input = document.getElementById('reportInput').value;
            const start = `${document.getElementById('startHour').value}:${document.getElementById('startMinute').value}`;

            if (!input.trim()) {
                showToast('ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const btn = document.getElementById('generateBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full loading-spinner"></div> ç”Ÿæˆä¸­...';

            if (currentReportMode === 'daily') {
                const end = `${document.getElementById('endHour').value}:${document.getElementById('endMinute').value}`;
                google.script.run.withSuccessHandler(onReportGenerated).withFailureHandler(e => {
                    showToast('Error: ' + e.message, true);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }).generateReportWithWarnings({
                    text: input,
                    start: start,
                    end: end
                });
            } else {
                // Accident Mode
                google.script.run.withSuccessHandler(onAccidentReportGenerated).withFailureHandler(e => {
                    showToast('Error: ' + e.message, true);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }).generateAccidentReport({
                    text: input,
                    start: start,
                    end: "" // not used potentially
                });
            }
        }

        function onReportGenerated(result) {
            const btn = document.getElementById('generateBtn');
            btn.disabled = false;
            btn.innerHTML = '<span>æ—¥å ±ã‚’ä½œæˆã™ã‚‹</span>';

            const warningsArea = document.getElementById('warningsArea');
            if (result.warnings && result.warnings.length > 0) {
                document.getElementById('warningsList').textContent = result.warnings.join(', ');
                warningsArea.classList.remove('hidden');
                warningsArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                warningsArea.classList.add('hidden');
                document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            let customerText = result.customer;
            if (currentStaffName) {
                const parts = currentStaffName.split(/[\sã€€]+/);
                if (parts.length > 0) {
                    customerText += '\n\n' + parts[0];
                }
            }

            document.getElementById('internalResult').value = result.internal;
            document.getElementById('customerResult').value = customerText;
            document.getElementById('resultArea').classList.remove('hidden');
            document.getElementById('saveBtnContainer').classList.remove('hidden'); // Show shared save button

            updateCharCounts();
        }

        function onAccidentReportGenerated(result) {
            const btn = document.getElementById('generateBtn');
            btn.disabled = false;
            btn.innerHTML = '<span>äº‹æ•…å ±å‘Šæ›¸ã‚’ä½œæˆã™ã‚‹</span>';

            if (result.error) {
                showToast(result.error, true);
                return;
            }

            // Populate fields
            document.getElementById('accOccurrenceTime').value = result.occurrenceTime || '';
            document.getElementById('accLocation').value = result.location || '';
            document.getElementById('accContent').value = result.accidentContent || '';
            document.getElementById('accSituation').value = result.situation || '';
            document.getElementById('accResponse').value = result.immediateResponse || '';
            document.getElementById('accParentCorrespondence').value = result.parentCorrespondence || '';
            document.getElementById('accDiagnosis').value = result.diagnosisTreatment || '';
            document.getElementById('accPrevention').value = result.prevention || '';

            document.getElementById('accidentResultArea').classList.remove('hidden');
            document.getElementById('accidentResultArea').scrollIntoView({ behavior: 'smooth', block: 'start' });
            document.getElementById('saveBtnContainer').classList.remove('hidden');
        }

        function updateCharCounts() {
            const internalLen = document.getElementById('internalResult').value.length;
            const customerLen = document.getElementById('customerResult').value.length;
            document.getElementById('internalCount').textContent = internalLen + 'æ–‡å­—';
            document.getElementById('customerCount').textContent = customerLen + 'æ–‡å­—';
        }

        function saveReport() {
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.textContent = 'ä¿å­˜ä¸­...';

            if (currentReportMode === 'daily') {
                const start = `${document.getElementById('startHour').value}:${document.getElementById('startMinute').value}`;
                const end = `${document.getElementById('endHour').value}:${document.getElementById('endMinute').value}`;

                google.script.run.withSuccessHandler((res) => {
                    const msg = (res && res.message) ? res.message : 'ä¿å­˜ã—ã¾ã—ãŸ';
                    const isWarning = (res && res.message && res.message.includes('å¤±æ•—'));
                    showToast(msg, isWarning);

                    if (!isWarning) {
                        closeModal();
                    }
                    btn.disabled = false;
                    btn.textContent = 'ä¿å­˜ã™ã‚‹';
                }).saveReport({
                    customerId: currentCustomer.id,
                    customerName: currentCustomer.name,
                    inputText: document.getElementById('reportInput').value,
                    start: start,
                    end: end,
                    internalText: document.getElementById('internalResult').value,
                    customerText: document.getElementById('customerResult').value,
                    staffName: currentStaffName,
                    images: currentImages // Add images
                });
            } else {
                // Save Accident
                const reportType = document.querySelector('input[name="accType"]:checked').value;

                google.script.run.withSuccessHandler(() => {
                    showToast(reportType + 'ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                    closeModal();
                    btn.disabled = false;
                    btn.textContent = 'ä¿å­˜ã™ã‚‹';
                }).saveAccidentReport({
                    customerId: currentCustomer.id,
                    customerName: currentCustomer.name,
                    staffName: currentStaffName,
                    targetName: document.getElementById('accTargetName').value,
                    targetDob: document.getElementById('accTargetDob').value,
                    inputText: document.getElementById('reportInput').value,
                    occurrenceTime: document.getElementById('accOccurrenceTime').value,
                    location: document.getElementById('accLocation').value,
                    accidentContent: document.getElementById('accContent').value,
                    situation: document.getElementById('accSituation').value,
                    immediateResponse: document.getElementById('accResponse').value,
                    parentCorrespondence: document.getElementById('accParentCorrespondence').value,
                    diagnosisTreatment: document.getElementById('accDiagnosis').value,
                    prevention: document.getElementById('accPrevention').value,
                    reportType: reportType
                });
            }
        }

        function startVoiceInput() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                showToast('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Web Speech APIã«ã‚ˆã‚‹éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚', true);
                return;
            }

            const micBtn = document.getElementById('micBtn');
            if (micBtn.disabled) return; // Prevent double click

            const recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            // UI updating
            micBtn.disabled = true;
            micBtn.classList.add('bg-red-100', 'text-red-700');
            micBtn.innerHTML = '<span class="animate-pulse">ğŸ”´</span> <span>èã„ã¦ã„ã¾ã™...</span>';

            recognition.start();

            recognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript;
                const textarea = document.getElementById('reportInput');
                textarea.value = (textarea.value ? textarea.value + "\n" : "") + transcript;
            };

            // Using onend to guaranteed cleanup
            recognition.onend = function () {
                resetMicBtn();
            };

            recognition.onerror = function (event) {
                console.error(event.error);
                // Alert specifically for troubleshooting
                if (event.error === 'not-allowed') {
                    showToast('ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§è¨±å¯ã—ã¦ãã ã•ã„ã€‚', true);
                } else if (event.error === 'no-speech') {
                    // Ignore, just silence
                } else if (event.error === 'network') {
                    showToast('éŸ³å£°èªè­˜ã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚', true);
                } else {
                    showToast('éŸ³å£°å…¥åŠ›ã‚¨ãƒ©ãƒ¼: ' + event.error, true);
                }
                resetMicBtn();
            };
        }

        function resetMicBtn() {
            const micBtn = document.getElementById('micBtn');
            micBtn.disabled = false;
            micBtn.classList.remove('bg-red-100', 'text-red-700');
            micBtn.innerHTML = '<span id="micIcon">ğŸ¤</span> <span>éŸ³å£°å…¥åŠ›</span>';
        }

        function copyToClipboard(elementId) {
            const el = document.getElementById(elementId);
            el.select();
            document.execCommand('copy');
            showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('bg-gray-800', 'bg-red-600', 'opacity-0', 'translate-y-4');

            if (isError) {
                toast.classList.add('bg-red-600');
            } else {
                toast.classList.add('bg-gray-800');
            }

            // Show
            toast.classList.remove('opacity-0');

            // Hide after 3s
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 3000);
        }
        // Image Handling
        let currentImages = []; // Array of { data: base64, amount: number|string, loading: boolean }

        function triggerCamera() {
            document.getElementById('cameraInput').click();
        }

        function triggerGallery() {
            document.getElementById('galleryInput').click();
        }

        function handleFileSelect(input) {
            const files = Array.from(input.files);
            if (files.length === 0) return;

            // Check limit
            if (currentImages.length + files.length > 6) {
                showToast('ç”»åƒã¯æœ€å¤§6æšã¾ã§ã§ã™', true);
                input.value = '';
                return;
            }

            let processedCount = 0;
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    resizeAndAddImage(e.target.result, () => {
                        processedCount++;
                        if (processedCount === files.length) {
                            input.value = ''; // Reset
                        }
                    });
                };
                reader.readAsDataURL(file);
            });
        }

        function resizeAndAddImage(base64Str, callback) {
            const img = new Image();
            img.onload = function () {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 1200;
                const MAX_HEIGHT = 1200;
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                } else {
                    if (height > MAX_HEIGHT) {
                        width *= MAX_HEIGHT / height;
                        height = MAX_HEIGHT;
                    }
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // Compress to JPEG 0.7
                const dataUrl = canvas.toDataURL('image/jpeg', 0.7);

                // Add to list with empty amount and loading state
                const newIdx = currentImages.length;
                currentImages.push({ data: dataUrl, amount: '', loading: true });
                renderImagePreviews();

                // Trigger OCR
                runOcr(newIdx, dataUrl);

                if (callback) callback();
            };
            img.src = base64Str;
        }

        function runOcr(index, base64Data) {
            google.script.run.withSuccessHandler(res => {
                if (currentImages[index]) {
                    currentImages[index].loading = false;
                    if (res.amount) {
                        currentImages[index].amount = res.amount;
                    }
                    renderImagePreviews();
                }
            }).withFailureHandler(e => {
                console.error("OCR Failed", e);
                if (currentImages[index]) {
                    currentImages[index].loading = false;
                    renderImagePreviews();
                }
            }).extractAmountFromImage(base64Data);
        }

        function renderImagePreviews() {
            const container = document.getElementById('imagePreviewContainer');
            container.innerHTML = '';

            currentImages.forEach((imgObj, idx) => {
                const div = document.createElement('div');
                div.className = 'relative w-28 flex flex-col gap-1 items-center'; // increased width

                // Image Container
                const imgDiv = document.createElement('div');
                imgDiv.className = 'relative w-24 h-24 rounded-xl overflow-hidden shadow-sm border border-gray-200 group bg-gray-100';

                imgDiv.innerHTML = `
                    <img src="${imgObj.data}" class="w-full h-full object-cover">
                    <button onclick="removeImage(${idx})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-80 hover:opacity-100 shadow-md z-10">
                        &times;
                    </button>
                    ${imgObj.loading ? '<div class="absolute inset-0 bg-black/30 flex items-center justify-center"><div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full loading-spinner"></div></div>' : ''}
                `;

                // Wrapper for input with "å††" label
                const inputContainer = document.createElement('div');
                inputContainer.className = "w-full px-1";
                // Using oninput to update model
                inputContainer.innerHTML = `
                    <input type="number" 
                        value="${imgObj.amount}" 
                        placeholder="é‡‘é¡" 
                        step="100"
                        oninput="currentImages[${idx}].amount = this.value"
                        class="w-full p-1 text-sm border border-gray-300 rounded text-center focus:ring-1 focus:ring-blue-500"
                    >
                `;

                div.appendChild(imgDiv);
                div.appendChild(inputContainer);
                container.appendChild(div);
            });

            // Toggle Add Button Visibility
            const camBtn = document.getElementById('addCameraBtn');
            const galBtn = document.getElementById('addGalleryBtn');

            if (currentImages.length >= 6) {
                if (camBtn) camBtn.classList.add('hidden');
                if (galBtn) galBtn.classList.add('hidden');
            } else {
                if (camBtn) camBtn.classList.remove('hidden');
                if (galBtn) galBtn.classList.remove('hidden');
            }
        }

        function removeImage(index) {
            currentImages.splice(index, 1);
            // Re-render will fix indices in handlers because it loops generic idx
            renderImagePreviews();
        }

        // Also reset images when opening modal
        const originalOpenModal = openModal;
        openModal = function (customer) {
            originalOpenModal(customer);
            currentImages = []; // Reset
            renderImagePreviews();
        };

    </script>
</body>

</html>
# セキュリティ強化提案書

現状の課題（パスワードの平文管理、クライアント側での簡易的なセッション管理）を解決し、Google認証を使用せずにセキュリティを大幅に向上させる修正案を提案します。

## 1. 課題の整理
1. **パスワード平文管理**: スプレッドシートを見れる人は誰でも全員のパスワードを知ることができてしまう。
2. **なりすましリスク**: `localStorage` に保存された名前だけでログイン状態を判断しているため、ブラウザのデータを改ざんするだけで他人の名前で操作できてしまう可能性がある（現状の `checkStaffActiveStatus` は名前の有効性しか確認していない）。

## 2. 改善案の概要
Googleアカウントに紐づかない**独自のセキュアな認証システム**をGAS上に構築します。

### A. パスワードのハッシュ化 (SHA-256)
- パスワードは平文で保存せず、不可逆な「ハッシュ値」として保存します。
- これにより、万が一管理用シートが漏洩しても、パスワードそのものは保護されます。

### B. トークンベースのセッション管理
- ログイン成功時に、サーバー側でランダムな **セッショントークン (UUID)** を発行します。
- クライアント（ブラウザ）はこのトークンを保存し、以降の通信では「名前」ではなく「トークン」を提示します。
- サーバー側で「このトークンは誰のものか？」を検証するため、なりすましが不可能になります。

## 3. 実装ステップ

### ステップ1: スタッフシートの構造変更
スタッフ管理シート（`STAFF_SS_ID`）に以下の列を追加・変更します。
- **パスワード列**: 平文 → ハッシュ値に変換
- **セッショントークン列**: 新規追加 (ログイン時に更新)
- **セッション有効期限列**: 新規追加 (最終アクセスから一定期間で無効化など)

### ステップ2: サーバー側コード (`コード.js`) の改修
1. **ハッシュ化関数の追加**: `Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256, password)` を利用。
2. **認証ロジックの変更**: 
   - 入力されたパスワードをハッシュ化し、保存されたハッシュ値と比較。
   - 一致した場合、新しいセッショントークンを発行してシートに保存。
3. **セッション検証ロジックの追加**:
   - 名前ではなくトークンを受け取り、有効なトークンかを確認してユーザー情報を返す関数を作成。
4. **移行用ツールの作成**:
   - 既存の平文パスワードを一括でハッシュ化するワンタイムスクリプト（`migrateToSecureAuth`）を用意。

### ステップ3: クライアント側コード (`index.html`) の改修
1. **ログイン処理**: 名前ではなく、返却されたトークンを `localStorage` に保存。
2. **起動時チェック**: 保存されたトークンを送信し、有効性を確認。

---

### ステップ4: パスワード変更機能の実装
ユーザー自身がパスワードを変更できる機能をアプリ設定画面に追加します。
1. **UI追加**: 設定モーダル内に「パスワード変更」ボタンを配置。
2. **変更フロー**:
   - 「現在のパスワード」「新しいパスワード」「確認用」を入力。
   - サーバー側で現在のパスワードが正しいか（ハッシュ検証）を確認した上で、新しいハッシュ値で上書き更新します。

### ステップ5: パスワードリセット（メール認証）
スタッフシートのE列（メールアドレス）を活用し、ユーザー自身でリセットできる機能を実装します。
1. **リクエスト**: ログイン画面の「パスワードを忘れた場合」からユーザーIDを入力。
2. **本人確認**:
   - サーバー側でIDに紐づくメールアドレス（E列）を取得。
   - ランダムな「6桁の認証コード」を生成し、そのメールアドレス宛に送信（`MailApp`を使用）。
3. **再設定**:
   - ユーザーが届いた認証コードを画面に入力。
   - 正しいコードであれば、その場で新しいパスワードを設定可能にします。
※ これにより管理者の手を煩わせることなく、安全にリカバリーが可能になります。

## 実行計画

この提案に基づき、以下の作業を行う準備ができています。

1. **コードの修正**: `コード.js` と `index.html` に上記の新機能を実装します（既存のロジックと並行稼働できるように `V2` 関数として追加することも可能です）。
2. **移行スクリプトの提供**: お客様自身でGASエディタから一度だけ実行していただく「データ移行機能」を追加します。

この方針で進めてよろしいでしょうか？
承認いただければ、直ちにコードの修正を行います。

<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ãƒãƒ›deå‡ºå‹¤ç°¿ä¿®æ­£</title>
    <style>
      /* --- å…¨ä½“ã®ãƒ™ãƒ¼ã‚¹ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
      body { 
        font-family: "Hiragino Maru Gothic Pro", "Meiryo UI", sans-serif; 
        padding: 0; margin: 0;
        background-color: #fdfcf5; 
        color: #4e342e; 
        background-image: radial-gradient(#e8f5e9 2px, transparent 2px);
        background-size: 30px 30px;
        font-size: 16px;
      }
      
      /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ --- */
      .header-hero {
        background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
        padding: 20px 20px 40px;
        text-align: center;
        border-radius: 0 0 50% 50% / 0 0 30px 30px;
        box-shadow: 0 4px 10px rgba(243, 156, 18, 0.2);
        color: #fff;
        margin-bottom: -30px;
        position: relative;
        overflow: hidden;
      }

      .hero-illustration { width: 140px; height: 100px; margin-bottom: 5px; filter: drop-shadow(0 4px 0 rgba(0,0,0,0.1)); }

      h2 { font-size: 24px; margin: 0; font-weight: bold; text-shadow: 1px 1px 0 rgba(0,0,0,0.1); letter-spacing: 1px; }
      .user-name { 
        font-size: 15px; margin-top: 10px; font-weight: bold; background: #fff; color: #f39c12; 
        display: inline-block; padding: 6px 18px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }

      /* --- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ --- */
      .container { padding: 20px; max-width: 600px; margin: 0 auto; padding-bottom: 50px; }

      .card { 
        background: white; padding: 25px 20px; border-radius: 20px; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 30px; 
        position: relative; z-index: 10; border: 2px solid #fff;
      }
      
      .section-box {
        border: 2px solid #8bc34a; border-radius: 15px; padding: 35px 20px 20px; 
        margin-bottom: 30px; background-color: #fff; position: relative;
      }
      
      .section-title {
        position: absolute; top: -18px; left: 15px; background: #8bc34a; color: white; 
        padding: 6px 20px; font-size: 16px; font-weight: bold; border-radius: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      /* --- ãƒ•ã‚©ãƒ¼ãƒ éƒ¨å“ --- */
      label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 16px; color: #689f38; margin-top: 20px; }
      label:first-child { margin-top: 5px; }
      
      /* â˜…ä¿®æ­£ï¼šinput[type="number"] ã‚’è¿½åŠ ã—ã¦ã€æ•°å­—å…¥åŠ›ã‚‚å¤§ããã—ã¾ã—ãŸ */
      input[type="text"], input[type="date"], input[type="number"], select { 
        width: 100%; padding: 12px; border: 2px solid #f1f8e9; border-radius: 12px; 
        font-size: 18px; /* æ–‡å­—ã‚µã‚¤ã‚ºå¤§ */
        box-sizing: border-box; height: 56px; 
        background-color: #f9fbe7; transition: 0.3s; color: #4e342e;
      }
      input:focus, select:focus { border-color: #8bc34a; background-color: #fff; outline: none; }
      
      /* èª­ã¿å–ã‚Šå°‚ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
      input[readonly] {
        background-color: #eeeeee; color: #777; border-color: #ddd; cursor: not-allowed;
      }
      input[readonly]:focus {
        border-color: #ddd; background-color: #eeeeee;
      }

      .row-group { display: flex; gap: 12px; align-items: flex-end; }
      .col-half { flex: 1; min-width: 0; }

      .time-wrapper { position: relative; display: flex; width: 100%; }
      .time-wrapper input[type="time"] {
        flex: 1; padding: 12px; border: 2px solid #f1f8e9; border-radius: 12px 0 0 12px; 
        font-size: 19px; height: 56px; -webkit-appearance: none;
        border-right: none; color: #4e342e; background-color: #f9fbe7;
      }
      .time-wrapper input:focus { background-color: #fff; border-color: #8bc34a; }

      .clock-icon {
        background: #f1f8e9; border: 2px solid #f1f8e9; border-left: none; border-radius: 0 12px 12px 0;
        width: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; 
        font-size: 24px; color: #8bc34a;
      }
      .time-wrapper input:focus + .clock-icon { border-color: #8bc34a; border-left: 2px solid #8bc34a; background: #fff; }

      .date-group { display: flex; gap: 12px; }
      .date-group input { flex: 1; }
      
      .search-btn { 
        background-color: #8bc34a; color: white; border: none; padding: 0 25px; 
        border-radius: 12px; font-weight: bold; font-size: 16px; height: 56px; box-shadow: 0 4px 0 #689f38;
      }
      .search-btn:active { transform: translateY(4px); box-shadow: none; }
      .search-btn:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed; }

      .save-btn { 
        width: 100%; background: linear-gradient(to right, #f39c12, #e67e22); 
        color: white; border: none; padding: 20px; border-radius: 35px; 
        font-size: 20px; font-weight: bold; margin-top: 30px; 
        box-shadow: 0 4px 10px rgba(230, 126, 34, 0.4);
      }
      .save-btn:disabled { background: #e0e0e0; box-shadow: none; color: #999; }

      #loading, #error-msg, #success-msg { display: none; padding: 20px; margin-bottom: 25px; text-align: center; font-weight: bold; border-radius: 15px; font-size: 16px; }
      #error-msg { color: #d32f2f; background: #ffcdd2; border: 2px solid #ef9a9a; }
      #success-msg { color: #388e3c; background: #c8e6c9; border: 2px solid #a5d6a7; }
      #form-area { display: none; animation: fadeIn 0.5s ease; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

      .footer-credit { text-align: center; margin-top: 40px; font-size: 12px; color: #aaa; font-weight: normal; }
    </style>
  </head>
  <body>

    <div class="header-hero">
      <svg class="hero-illustration" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 140 100">
        <g transform="translate(10, 20) rotate(-10)">
          <path d="M15 80 L20 40 L25 80 Z" fill="#f1c40f" /><circle cx="20" cy="40" r="15" fill="#f1c40f" />
          <circle cx="16" cy="36" r="2" fill="#333" /><path d="M15 25 L15 30 M25 25 L25 30" stroke="#f39c12" stroke-width="2" />
          <circle cx="12" cy="45" r="3" fill="#e67e22" opacity="0.6" />
        </g>
        <g transform="translate(70, 30)">
          <circle cx="0" cy="0" r="22" fill="#e67e22" /><circle cx="0" cy="0" r="15" fill="#f1c40f" />
          <circle cx="-5" cy="-2" r="2" fill="#333" /><circle cx="5" cy="-2" r="2" fill="#333" />
          <path d="M-2 5 Q0 8 2 5" stroke="#333" stroke-width="1.5" fill="none"/><polygon points="-5,-20 0,-10 5,-20" fill="#e74c3c" />
        </g>
        <g transform="translate(120, 40) rotate(10)">
          <path d="M-15 0 Q0 -15 15 0 Q15 30 -15 30 Z" fill="#f39c12" /><circle cx="-6" cy="10" r="5" fill="#fff" />
          <circle cx="6" cy="10" r="5" fill="#fff" /><circle cx="-6" cy="10" r="2" fill="#333" /><circle cx="6" cy="10" r="2" fill="#333" />
          <path d="M-2 15 L0 18 L2 15" fill="#e67e22" /><path d="M-15 15 L-25 5 M15 15 L25 5" stroke="#f39c12" stroke-width="3" stroke-linecap="round"/>
        </g>
        <text x="30" y="20" font-size="15" fill="#fff">â™ª</text><text x="100" y="20" font-size="10" fill="#fff">â™ª</text>
      </svg>
      <h2>ã‚¹ãƒãƒ›deå‡ºå‹¤ç°¿ä¿®æ­£</h2>
      <div id="user-info" class="user-name">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div class="container">
      <div id="error-msg"></div><div id="success-msg"></div>

      <div class="card">
        <label style="margin-top:0;">ğŸ“… ä¿®æ­£ã—ãŸã„æ—¥ä»˜</label>
        <div class="date-group">
          <input type="date" id="target-date" onchange="checkDateLimit()">
          <button class="search-btn" id="search-btn" onclick="searchData()">è¡¨ç¤º</button>
        </div>
      </div>
      <div id="loading"><div style="font-size:30px; color:#f39c12;">â³</div><div style="color:#e67e22; font-size:16px;">ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢ä¸­...</div></div>

      <form id="attendance-form" onsubmit="handleFormSubmit(this); return false;">
        <div id="form-area">
          <input type="hidden" name="rowNumber" id="rowNumber">
          <input type="hidden" name="targetDateStr" id="targetDateStr">

          <div class="section-box">
            <div class="section-title">æ¥­å‹™ #1</div>
            <label>ğŸ“ è¨ªå•å…ˆç­‰ (Cåˆ—)</label>
            <input type="text" name="col_C" id="col_C" placeholder="(ç®¡ç†è€…è¨­å®š)" readonly onclick="showReadOnlyMsg()">
            
            <div class="row-group">
              <div class="col-half"><label>å§‹æ¥­ (Dåˆ—)</label><div class="time-wrapper"><input type="time" name="col_D" id="col_D" step="60"><div class="clock-icon" onclick="openPicker('col_D')">ğŸ•’</div></div></div>
              <div class="col-half"><label>çµ‚æ¥­ (Eåˆ—)</label><div class="time-wrapper"><input type="time" name="col_E" id="col_E" step="60"><div class="clock-icon" onclick="openPicker('col_E')">ğŸ•’</div></div></div>
            </div>
            <label>â›… å¤©å€™ (Iåˆ—)</label><select name="col_I" id="col_I"><option value="">é¸æŠ...</option></select>
          </div>

          <div class="section-box">
            <div class="section-title">æ¥­å‹™ #2</div>
            <label>ğŸ“ è¨ªå•å…ˆç­‰ (Låˆ—)</label>
            <input type="text" name="col_L" id="col_L" placeholder="(ç®¡ç†è€…è¨­å®š)" readonly onclick="showReadOnlyMsg()">
            
            <div class="row-group">
              <div class="col-half"><label>å§‹æ¥­ (Måˆ—)</label><div class="time-wrapper"><input type="time" name="col_M" id="col_M" step="60"><div class="clock-icon" onclick="openPicker('col_M')">ğŸ•’</div></div></div>
              <div class="col-half"><label>çµ‚æ¥­ (Nåˆ—)</label><div class="time-wrapper"><input type="time" name="col_N" id="col_N" step="60"><div class="clock-icon" onclick="openPicker('col_N')">ğŸ•’</div></div></div>
            </div>
            <label>â›… å¤©å€™ (Råˆ—)</label><select name="col_R" id="col_R"><option value="">é¸æŠ...</option></select>
          </div>

          <div class="section-box">
            <div class="section-title">æ¥­å‹™ #3</div>
            <label>ğŸ“ è¨ªå•å…ˆç­‰ (Uåˆ—)</label>
            <input type="text" name="col_U" id="col_U" placeholder="(ç®¡ç†è€…è¨­å®š)" readonly onclick="showReadOnlyMsg()">
            
            <div class="row-group">
              <div class="col-half"><label>å§‹æ¥­ (Våˆ—)</label><div class="time-wrapper"><input type="time" name="col_V" id="col_V" step="60"><div class="clock-icon" onclick="openPicker('col_V')">ğŸ•’</div></div></div>
              <div class="col-half"><label>çµ‚æ¥­ (Wåˆ—)</label><div class="time-wrapper"><input type="time" name="col_W" id="col_W" step="60"><div class="clock-icon" onclick="openPicker('col_W')">ğŸ•’</div></div></div>
            </div>
          </div>

          <div class="section-box">
            <div class="section-title">ä½œæ¥­ #1</div>
            <label>ğŸ“ ä½œæ¥­å†…å®¹ (Xåˆ—)</label><select name="col_X" id="col_X"><option value="">é¸æŠ...</option></select>
            <div class="row-group">
              <div class="col-half"><label>é–‹å§‹ (Yåˆ—)</label><div class="time-wrapper"><input type="time" name="col_Y" id="col_Y" step="60"><div class="clock-icon" onclick="openPicker('col_Y')">ğŸ•’</div></div></div>
              <div class="col-half"><label>çµ‚äº† (Zåˆ—)</label><div class="time-wrapper"><input type="time" name="col_Z" id="col_Z" step="60"><div class="clock-icon" onclick="openPicker('col_Z')">ğŸ•’</div></div></div>
            </div>
          </div>

          <div class="section-box">
            <div class="section-title">ä½œæ¥­ #2</div>
            <label>ğŸ“ ä½œæ¥­å†…å®¹ (AAåˆ—)</label><select name="col_AA" id="col_AA"><option value="">é¸æŠ...</option></select>
            <div class="row-group">
              <div class="col-half"><label>é–‹å§‹ (ABåˆ—)</label><div class="time-wrapper"><input type="time" name="col_AB" id="col_AB" step="60"><div class="clock-icon" onclick="openPicker('col_AB')">ğŸ•’</div></div></div>
              <div class="col-half"><label>çµ‚äº† (ACåˆ—)</label><div class="time-wrapper"><input type="time" name="col_AC" id="col_AC" step="60"><div class="clock-icon" onclick="openPicker('col_AC')">ğŸ•’</div></div></div>
            </div>
          </div>

          <div class="section-box">
            <div class="section-title">è²·ç‰©ä»£è¡Œ</div>
            <label>ğŸ›’ è²·ç‰©å›æ•° (ANåˆ—)</label>
            <input type="number" name="col_AN" id="col_AN" placeholder="å›æ•°ã‚’å…¥åŠ› (ä¾‹: 1)" min="0">
          </div>

          <div class="section-box">
            <div class="section-title">ãã®ä»–</div>
            <label>ğŸ’¬ å‚™è€ƒ (AOåˆ—)</label><input type="text" name="col_AO" id="col_AO" placeholder="å‚™è€ƒãŒã‚ã‚Œã°å…¥åŠ›">
          </div>

          <button type="submit" class="save-btn" id="submit-btn">ä¿®æ­£ã‚’ä¿å­˜ã™ã‚‹</button>
          <div class="footer-credit">Powered by ã‹ãŸã²ã‚‚</div>
        </div>
      </form>
    </div>

    <script>
      window.onload = function() {
        var today = new Date();
        var yyyy = today.getFullYear();
        var mm = ("0" + (today.getMonth() + 1)).slice(-2);
        var dd = ("0" + today.getDate()).slice(-2);
        document.getElementById('target-date').value = yyyy + '-' + mm + '-' + dd;
        
        checkDateLimit();

        google.script.run
          .withSuccessHandler(function(data) {
            if (data.success) {
              document.getElementById('user-info').textContent = 'ã‚ˆã†ã“ã ' + data.userName + ' ã•ã‚“';
              setupDropdown('col_I', data.optionsI);
              setupDropdown('col_R', data.optionsR);
              setupDropdown('col_X', data.optionsX);
              setupDropdown('col_AA', data.optionsAA);
            } else {
              showError("åˆæœŸã‚¨ãƒ©ãƒ¼: " + data.error);
            }
          })
          .withFailureHandler(function(e) {
            showError("ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šã‚¨ãƒ©ãƒ¼: " + e);
          })
          .getInitialData();
      };

      function showReadOnlyMsg() {
        showError("ğŸ”’ ã“ã®é …ç›®ã¯ç®¡ç†è€…å´ã§è¨­å®šã—ã¦ã„ã‚‹ãŸã‚ã€ç·¨é›†ã§ãã¾ã›ã‚“ã€‚");
      }

      function checkDateLimit() {
        var dateVal = document.getElementById('target-date').value;
        if (!dateVal) return;
        var inputDate = new Date(dateVal.replace(/-/g, '/'));
        var today = new Date();
        inputDate.setHours(0,0,0,0); today.setHours(0,0,0,0);
        var limitDate = new Date(today); limitDate.setDate(today.getDate() - 7);

        var btn = document.getElementById('search-btn');
        var form = document.getElementById('form-area');
        if (inputDate < limitDate) {
          showError("âš ï¸ ä¿®æ­£æœŸé™ã‚’éãã¦ã„ã¾ã™ï¼ˆ7æ—¥å‰ã¾ã§ä¿®æ­£å¯ï¼‰");
          btn.disabled = true; form.style.display = 'none';
        } else {
          hideMessages();
          btn.disabled = false;
        }
      }

      function setupDropdown(id, options) {
        var select = document.getElementById(id);
        if (!options || options.length === 0) return;
        select.innerHTML = '<option value="">(é¸æŠã—ã¦ãã ã•ã„)</option>';
        options.forEach(function(opt) {
          var optionTag = document.createElement('option');
          optionTag.value = opt; optionTag.text = opt; select.appendChild(optionTag);
        });
      }

      function openPicker(id) { var el=document.getElementById(id); if(el&&el.showPicker)el.showPicker(); else el.focus(); }

      function searchData() {
        var dateVal = document.getElementById('target-date').value;
        var btn = document.getElementById('search-btn');
        if (!dateVal || btn.disabled) return;

        showLoading(true); hideMessages();
        document.getElementById('form-area').style.display = 'none';
        document.getElementById('targetDateStr').value = dateVal;

        google.script.run
          .withSuccessHandler(displayForm)
          .withFailureHandler(function(e){ showLoading(false); showError(e); })
          .getDataByDate(dateVal);
      }

      function displayForm(result) {
        showLoading(false);
        if (!result.success) return showError(result.error);
        document.getElementById('form-area').style.display = 'block';
        document.getElementById('rowNumber').value = result.rowNumber;
        
        var d = result.rowData;
        setValue('col_C', d.C); setValue('col_D', d.D); setValue('col_E', d.E); setValue('col_I', d.I);
        setValue('col_L', d.L); setValue('col_M', d.M); setValue('col_N', d.N); setValue('col_R', d.R);
        setValue('col_U', d.U); setValue('col_V', d.V); setValue('col_W', d.W);
        setValue('col_X', d.X); setValue('col_Y', d.Y); setValue('col_Z', d.Z);
        setValue('col_AA', d.AA); setValue('col_AB', d.AB); setValue('col_AC', d.AC);
        setValue('col_AN', d.AN);
        setValue('col_AO', d.AO);
      }

      function setValue(id, val) { var el=document.getElementById(id); if(el) el.value=val; }

      function handleFormSubmit(form) {
        var btn = document.getElementById('submit-btn');
        btn.disabled = true; btn.textContent = "ä¿å­˜ä¸­...";
        hideMessages();
        google.script.run
          .withSuccessHandler(function(res) {
            btn.disabled = false; btn.textContent = "ä¿®æ­£ã‚’ä¿å­˜ã™ã‚‹";
            if(res.success) {
              showSuccess(res.message);
            } else {
              showError(res.error);
            }
          })
          .withFailureHandler(function(e) {
            btn.disabled = false; btn.textContent = "ä¿®æ­£ã‚’ä¿å­˜ã™ã‚‹"; showError(e);
          })
          .updateData(form);
      }

      function showLoading(b) { document.getElementById('loading').style.display = b ? 'block' : 'none'; }
      function showError(m) { var e=document.getElementById('error-msg'); e.innerText=m; e.style.display='block'; window.scrollTo({top:0, behavior:'smooth'}); }
      
      function showSuccess(m) { 
        var s=document.getElementById('success-msg'); 
        s.innerText=m; 
        s.style.display='block';
        window.scrollTo({ top: 0, behavior: 'smooth' }); 
      }
      
      function hideMessages() { document.getElementById('error-msg').style.display='none'; document.getElementById('success-msg').style.display='none'; }
    </script>
  </body>
</html>